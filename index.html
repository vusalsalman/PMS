<!DOCTYPE html>
<html lang="az">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MinAli Boutique Hotel PMS System</title>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.4.0/exceljs.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <style>
        @import url("https://fonts.googleapis.com/css2?family=Be+Vietnam+Pro:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap");

        :root {
            --c-gray-900: #000000;
            --c-gray-800: #1f1f1f;
            --c-gray-700: #2e2e2e;
            --c-gray-600: #313131;
            --c-gray-500: #969593;
            --c-gray-400: #a6a6a6;
            --c-gray-300: #bdbbb7;
            --c-gray-200: #f1f1f1;
            --c-gray-100: #ffffff;
            --c-green-500: #45ffbc;
            --c-olive-500: #e3ffa8;
            --c-red-500: #ff6b6b;
            --c-white: var(--c-gray-100);
            --c-text-primary: var(--c-gray-100);
            --c-text-secondary: var(--c-gray-200);
            --c-text-tertiary: var(--c-gray-500);
            
            /* Status colors */
            --status-1: #FFEB3B; /* Rezerv olunub ödəniş olunmuyub */
            --status-2: #8BC34A; /* Rezerv olunub qismi ödəniş olunub */
            --status-3: #0a420c; /* Rezerv olunub tam ödəniş olunub */
            --status-4: #a2e0a5; /* Rezerv dəqiqləşdirilib */
            --status-5: #555ff1; /* Qonaq giriş edib tam ödəniş edib */
            --status-6: #65dbff; /* Qonaq giriş edib qismi ödəniş edib */
            --status-7: #ff0062; /* Qonaq giriş edib ödəniş etməyib */
            --status-8: #330703; /* Qonaq gəlmədi */
            --status-9: #535353; /* Qonaq giriş edib çıxışda edib tam ödəniş edib */
            --status-10: #fa1212; /* Qonaq giriş edib çıxış edib ödəniş etməyib */
            --status-11: #fa6f6f; /* Qonaq giriş edib çıxış edib qismi ödəniş edib */
            --status-12: #e610db; /* Qonaq giriş edib çıxış edib artıq ödəniş edib */
        }

        body {
            line-height: 1.5;
            min-height: 100vh;
            font-family: "Be Vietnam Pro", sans-serif;
            background-color: var(--c-gray-900);
            color: var(--c-text-primary);
            display: flex;
            padding-top: 3vw;
            padding-bottom: 3vw;
            justify-content: center;
            margin: 0;
        }

        * {
            box-sizing: border-box;
        }

        .responsive-wrapper {
            width: 90%;
            max-width: 1600px;
            margin-left: auto;
            margin-right: auto;
        }

        .app {
            min-height: 80vh;
            width: 95%;
            max-width: 1600px;
            background-color: var(--c-gray-800);
            padding: 2vw 4vw 6vw;
            display: flex;
            flex-direction: column;
            border-radius: 10px;
        }

        .app-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--c-gray-600);
        }

        .logo {
            display: flex;
            align-items: center;
        }

        .logo-icon {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 32px;
            height: 32px;
            background-color: var(--c-green-500);
            border-radius: 6px;
            color: var(--c-gray-800);
            font-weight: bold;
        }

        .logo-title {
            display: flex;
            flex-direction: column;
            line-height: 1.25;
            margin-left: 0.75rem;
        }

        .tabs {
            display: flex;
            color: var(--c-text-tertiary);
            margin-top: 2rem;
        }

        .tab {
            padding: 0.5rem 1rem;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: 0.25s ease;
        }

        .tab.active {
            color: var(--c-text-primary);
            border-bottom: 2px solid var(--c-text-primary);
        }

        .tab-content {
            display: none;
            margin-top: 1.5rem;
        }

        .tab-content.active {
            display: block;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        label {
            display: block;
            margin-bottom: 0.5rem;
            color: var(--c-text-secondary);
        }

        input, select, textarea {
            width: 100%;
            padding: 0.75rem;
            background-color: var(--c-gray-700);
            border: 1px solid var(--c-gray-600);
            border-radius: 6px;
            color: var(--c-text-primary);
        }

        button {
            padding: 0.75rem 1.5rem;
            background-color: var(--c-green-500);
            color: var(--c-gray-800);
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: 0.25s ease;
        }

        button:hover {
            opacity: 0.9;
            transform: translateY(-2px);
        }

        .btn-outline {
            background-color: transparent;
            border: 1px solid var(--c-gray-600);
            color: var(--c-text-primary);
        }

        .btn-outline:hover {
            background-color: var(--c-gray-600);
        }

        .btn-red {
            background-color: var(--c-red-500);
            color: white;
        }

        .dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
            margin-top: 2rem;
        }

        .card {
            background-color: var(--c-gray-700);
            border-radius: 8px;
            padding: 1.5rem;
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .card-title {
            font-size: 1.25rem;
            font-weight: 600;
        }

        .card-value {
            font-size: 2rem;
            font-weight: 700;
            margin: 1rem 0;
        }

        .income {
            color: var(--c-green-500);
        }

        .expense {
            color: var(--c-red-500);
        }

        .transactions {
            margin-top: 2rem;
        }

        .transaction {
            display: flex;
            justify-content: space-between;
            padding: 1rem 0;
            border-bottom: 1px solid var(--c-gray-600);
        }

        .transaction:last-child {
            border-bottom: none;
        }

        .transaction-type {
            display: inline-block;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .transaction-income {
            background-color: rgba(69, 255, 188, 0.2);
            color: var(--c-green-500);
        }

        .transaction-expense {
            background-color: rgba(255, 107, 107, 0.2);
            color: var(--c-red-500);
        }

        .category-badge {
            display: inline-block;
            padding: 0.25rem 0.5rem;
            background-color: var(--c-gray-600);
            border-radius: 4px;
            font-size: 0.75rem;
            margin-left: 0.5rem;
        }

        .hidden {
            display: none;
        }

        .categories-list {
            margin-top: 1rem;
        }

        .category-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem;
            background-color: var(--c-gray-700);
            border-radius: 6px;
            margin-bottom: 0.5rem;
        }

        .delete-btn {
            background-color: var(--c-red-500);
            color: white;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.75rem;
        }

        .date-range-selector {
            display: flex;
            gap: 1rem;
            margin-bottom: 1.5rem;
            align-items: center;
        }

        .date-range-selector label {
            margin-bottom: 0;
        }

        .payment-method-selector {
            margin-top: 1rem;
        }

        .payment-method-option {
            display: flex;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .payment-method-option input {
            width: auto;
            margin-right: 0.5rem;
        }

        .table-container {
            overflow-x: auto;
            margin-top: 1.5rem;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid var(--c-gray-600);
        }

        th {
            background-color: var(--c-gray-600);
            font-weight: 600;
        }

        tr:hover {
            background-color: var(--c-gray-700);
        }

        .alert {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 8px;
            color: white;
            font-weight: 500;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            z-index: 10000;
            display: flex;
            align-items: center;
            gap: 10px;
            transform: translateX(150%);
            transition: transform 0.3s ease-in-out;
        }

        .alert.show {
            transform: translateX(0);
        }

        .alert-success {
            background-color: var(--c-green-500);
        }

        .alert-danger {
            background-color: var(--c-red-500);
        }

        .close-alert {
            margin-left: 15px;
            cursor: pointer;
            font-weight: bold;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0,) !important;
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background-color: var(--c-gray-800);
            border-radius: 15px;
            width: 600px;
            max-width: 95%;
            max-height: 90vh;
            overflow-y: auto;
            padding: 20px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: var(--c-text-secondary);
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 15px;
        }

        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        .reservation-income {
            background-color: rgba(69, 255, 188, 0.1);
            padding: 1rem;
            border-radius: 8px;
            margin-top: 1rem;
            border-left: 4px solid var(--c-green-500);
        }
        
        /* Reservation Timeline Styles */
        .timeline-container {
            background: var(--c-gray-700);
            border-radius: 15px;
            padding: 1.5rem;
            margin-top: 1.5rem;
        }

        .timeline-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
            gap: 10px;
        }

        .timeline-nav {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .timeline-grid {
            display: grid;
            grid-template-columns: 120px repeat(7, 1fr);
            gap: 5px;
            overflow-x: auto;
        }

        .timeline-cell {
            border: 1px solid var(--c-gray-600);
            padding: 8px;
            min-height: 80px;
            background-color: var(--c-gray-700);
            position: relative;
        }

        .timeline-cell.header {
            font-weight: 500;
            text-align: center;
            background-color: var(--c-gray-600);
            position: sticky;
            left: 0;
            z-index: 2;
        }

        .room-cell {
            position: relative;
            padding: 0;
        }

        .reservation {
            background-color: var(--c-green-500);
            color: var(--c-gray-800);
            padding: 4px 8px;
            border-radius: 6px;
            margin-bottom: 0;
            font-size: 12px;
            cursor: pointer;
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            overflow: hidden;
            white-space: nowrap;
            text-overflow: ellipsis;
            transition: all 0.2s;
        }

        /* Status colors */
        .reservation.status-1 { background-color: var(--status-1); color: #000; }
        .reservation.status-2 { background-color: var(--status-2); color: #000; }
        .reservation.status-3 { background-color: var(--status-3); color: white; }
        .reservation.status-4 { background-color: var(--status-4); color: white; }
        .reservation.status-5 { background-color: var(--status-5); color: white; }
        .reservation.status-6 { background-color: var(--status-6); color: #000; }
        .reservation.status-7 { background-color: var(--status-7); color: #000; }
        .reservation.status-8 { background-color: var(--status-8); color: white; }
        .reservation.status-9 { background-color: var(--status-9); color: white; }
        .reservation.status-10 { background-color: var(--status-10); color: white; }
        .reservation.status-11 { background-color: var(--status-11); color: #000; }
        .reservation.status-12 { background-color: var(--status-12); color: #000; }

        .reservation.booking {
            border-left: 5px solid var(--c-green-500);
        }

        .reservation:hover {
            transform: scale(1.02);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
            z-index: 10;
            white-space: normal;
            overflow: visible;
        }

        .reservation-timeline {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 3px;
            background-color: rgba(0, 0, 0, 0.3);
        }

        .reservation-progress {
            height: 100%;
            background-color: var(--c-gray-800);
        }

        .reservation-info {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .reservation-company {
            font-size: 10px;
            margin-top: 2px;
            display: block;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .reservation-hover-info {
            display: none;
            position: absolute;
            top: 100%;
            left: 0;
            background: var(--c-gray-700);
            border: 1px solid var(--c-green-500);
            padding: 8px;
            border-radius: 6px;
            z-index: 20;
            width: max-content;
            max-width: 200px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
            color: var(--c-text-primary);
        }

        .reservation:hover .reservation-hover-info {
            display: block;
        }

        .payment-icon {
            display: inline-block;
            width: 16px;
            height: 16px;
            margin-right: 5px;
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
        }

        .payment-methods {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 15px;
        }

        .payment-method {
            display: flex;
            align-items: center;
            padding: 8px 12px;
            background-color: var(--c-gray-600);
            border-radius: 8px;
            margin-bottom: 10px;
            width: 100%;
        }

        .payment-method input[type="checkbox"] {
            width: auto;
            margin-right: 8px;
        }

        .payment-amount {
            margin-left: auto;
            width: 100px;
            padding: 8px;
            border: 1px solid var(--c-gray-600);
            border-radius: 8px;
            background-color: var(--c-gray-700);
            color: var(--c-text-primary);
        }

        .booking-checkbox {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 15px;
        }

        .status-actions {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        .reservation-details {
            margin-top: 20px;
            padding: 15px;
            background-color: var(--c-gray-600);
            border-radius: 8px;
        }

        .reservation-details p {
            margin-bottom: 8px;
            font-size: 14px;
        }

        .reservation-details strong {
            display: inline-block;
            width: 150px;
            color: var(--c-text-secondary);
        }

        .current-status {
            margin-top: 15px;
            padding: 10px;
            border-radius: 8px;
            font-weight: bold;
            text-align: center;
        }

        /* Group reservation modal */
        .group-modal-content {
            background-color: var(--c-gray-800);
            border-radius: 15px;
            width: 800px;
            max-width: 95%;
            max-height: 90vh;
            overflow-y: auto;
            padding: 20px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        }

        .group-rooms-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 10px;
            margin-top: 20px;
        }

        .group-room-card {
            border: 1px solid var(--c-gray-600);
            border-radius: 8px;
            padding: 10px;
            cursor: pointer;
        }

        .group-room-card.selected {
            border-color: var(--c-green-500);
            background-color: rgba(69, 255, 188, 0.1);
        }

        .group-room-card input[type="checkbox"] {
            margin-right: 8px;
        }

        .reservation-summary {
            margin-top: 20px;
            padding: 15px;
            background-color: var(--c-gray-600);
            border-radius: 8px;
        }

        .reservation-summary h4 {
            margin-bottom: 10px;
            color: var(--c-green-500);
        }

        .summary-item {
            margin-bottom: 8px;
            font-size: 14px;
            display: flex;
        }

        .summary-item strong {
            display: inline-block;
            width: 120px;
            color: var(--c-text-secondary);
        }

        /* Export options */
        .export-options {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            justify-content: center;
        }

        .export-option {
            padding: 10px 15px;
            border-radius: 8px;
            background-color: var(--c-gray-600);
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.2s;
        }

        .export-option:hover {
            background-color: var(--c-green-500);
            color: var(--c-gray-800);
        }

        .export-option i {
            font-size: 18px;
        }
        
        .registration-form {
            background-color: var(--c-gray-700);
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
        }
        
        .signature-area {
            display: flex;
            justify-content: space-between;
            margin-top: 50px;
        }
        
        .signature-line {
            border-top: 1px solid var(--c-text-primary);
            width: 200px;
            text-align: center;
            padding-top: 5px;
        }
        
        /* Group reservation invoice button */
        .group-invoice-btn {
            margin-top: 20px;
            width: 100%;
        }

        /* Form elements */
        .form-label {
            display: block;
            margin-bottom: 8px;
            font-size: 14px;
            color: var(--c-text-secondary);
        }

        .form-control {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid var(--c-gray-600);
            border-radius: 8px;
            font-size: 14px;
            background-color: var(--c-gray-700);
            color: var(--c-text-primary);
        }

        .form-control:focus {
            outline: none;
            border-color: var(--c-green-500);
            box-shadow: 0 0 0 2px rgba(69, 255, 188, 0.2);
        }

        .form-select {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid var(--c-gray-600);
            border-radius: 8px;
            font-size: 14px;
            background-color: var(--c-gray-700);
            color: var(--c-text-primary);
        }
        
        /* Filter controls */
        .filter-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }
        
        /* Timeline month/year display */
        .timeline-date-display {
            font-size: 1.2rem;
            font-weight: 600;
            margin-right: 20px;
        }

        /* Workday styles */
.workday {
    background-color: var(--c-green-500);
    color: var(--c-gray-800);
    padding: 4px 8px;
    border-radius: 6px;
    margin-bottom: 0;
    font-size: 12px;
    cursor: pointer;
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    overflow: hidden;
    white-space: nowrap;
    text-overflow: ellipsis;
    transition: all 0.2s;
}

.workday:hover {
    transform: scale(1.02);
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
    z-index: 10;
    white-space: normal;
    overflow: visible;
}

.workday-info {
    display: flex;
    align-items: center;
    gap: 5px;
}

.workday-amount {
    font-weight: bold;
}
    </style>
</head>
<body>
    <div id="alert-container"></div>
    <!-- Login Modal -->
<div class="modal" id="loginModal" style="display: flex; background-color: black;">
    <div class="modal-content" style="max-width: 400px;">
        <div class="modal-header">
            <h3>Hotel Maliyyə Paneli - Giriş</h3>

            AAAA
        </div>
        <form id="login-form">
            <div class="form-group">
                <label for="login-role">Rol</label>
                <select id="login-role" class="form-control" required>
                    <option value="">Seçin</option>

                    <option value="manager">Menecer</option>
                    <option value="reception">Resepşn</option>
                </select>
            </div>
            <div class="form-group" id="password-group" style="display: none;">
                <label for="login-password">Parol</label>
                <input type="password" id="login-password" class="form-control">
            </div>
            <div class="modal-footer">
                <button type="submit" class="btn">Daxil ol</button>
            </div>
        </form>
    </div>
</div>
    <div class="responsive-wrapper">
        <div class="app">
            <header class="app-header">
                <div class="logo">
                    <div class="logo-icon">H</div>
                    <div class="logo-title">
                        <span>Hotel Maliyyə Paneli</span>
                    </div>
                </div>
            </header>

            <div class="tabs">
                <div class="tab active" data-tab="dashboard">İdarə Paneli</div>
                <div class="tab" data-tab="transactions">Əməliyyatlar</div>
                <div class="tab" data-tab="categories">Kateqoriyalar</div>
                <div class="tab" data-tab="reservations">Rezervasiyalar</div>
                <div class="tab" data-tab="personal">İşçi idarəetməsi</div>
            </div>

            <div class="tab-content active" id="dashboard">
                <div class="date-range-selector">
                    <div>
                        <label for="export-start-date">Başlanğıc tarixi</label>
                        <input type="date" id="export-start-date" class="form-control">
                    </div>
                    <div>
                        <label for="export-end-date">Bitmə tarixi</label>
                        <input type="date" id="export-end-date" class="form-control">
                    </div>
                    <button class="btn btn-outline" id="export-excel-btn">Excel Export</button>
                </div>

                <div class="dashboard">
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">Ümumi Gəlir</div>
                        </div>
                        <div class="card-value income" id="total-income">0 ₼</div>
                        <div class="card-subtitle" id="income-period">Bu ay</div>
                    </div>
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">Ümumi Xərc</div>
                        </div>
                        <div class="card-value expense" id="total-expense">0 ₼</div>
                        <div class="card-subtitle" id="expense-period">Bu ay</div>
                    </div>
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">Xalis Mənfəət</div>
                        </div>
                        <div class="card-value" id="net-profit">0 ₼</div>
                        <div class="card-subtitle" id="profit-period">Bu ay</div>
                    </div>
                </div>

                <div class="transactions">
                    <h3>Son Əməliyyatlar</h3>
                    <div id="recent-transactions">
                        <!-- Əməliyyatlar burada yerləşəcək -->
                    </div>
                </div>
            </div>

            <div class="tab-content" id="transactions">
                <form id="transaction-form">
                    <div class="form-group">
                        <label for="transaction-type">Növ</label>
                        <select id="transaction-type" required>
                            <option value="">Seçin</option>
                            <option value="income">Gəlir</option>
                            <option value="expense">Xərc</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="transaction-category">Kateqoriya</label>
                        <select id="transaction-category" required>
                            <option value="">Seçin</option>
                            <!-- Kateqoriyalar JavaScript ilə əlavə olunacaq -->
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="transaction-amount">Məbləğ (₼)</label>
                        <input type="number" id="transaction-amount" placeholder="Məbləği daxil edin" required step="0.01">
                    </div>

                    <div class="form-group">
                        <label for="transaction-description">Təsvir</label>
                        <textarea id="transaction-description" rows="2" placeholder="Ətraflı təsvir"></textarea>
                    </div>

                    <div class="form-group">
                        <label for="transaction-date">Tarix</label>
                        <input type="datetime-local" id="transaction-date" required>
                    </div>

                    <div class="payment-method-selector">
                        <label>Ödəniş üsulu</label>
                        <div class="payment-method-option">
                            <input type="radio" id="payment-cash" name="payment-method" value="cash" checked>
                            <label for="payment-cash">Nağd</label>
                        </div>
                        <div class="payment-method-option">
                            <input type="radio" id="payment-card" name="payment-method" value="card">
                            <label for="payment-card">Kart</label>
                        </div>
                        <div class="payment-method-option">
                            <input type="radio" id="payment-transfer" name="payment-method" value="transfer">
                            <label for="payment-transfer">Kartdan-karta</label>
                        </div>
                    </div>

                    <div class="form-group">
                        <button type="submit" class="btn">Əməliyyat əlavə et</button>
                    </div>
                </form>

                <div class="table-container">
                    <table id="transactions-table">
                        <thead>
                            <tr>
                                <th>Tarix</th>
                                <th>Növ</th>
                                <th>Kateqoriya</th>
                                <th>Məbləğ</th>
                                <th>Ödəniş üsulu</th>
                                <th>Təsvir</th>
                                <th>Əməliyyat</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Əməliyyatlar burada yerləşəcək -->
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="tab-content" id="categories">
                <form id="category-form">
                    <div class="form-group">
                        <label for="category-type">Növ</label>
                        <select id="category-type" required>
                            <option value="">Seçin</option>
                            <option value="income">Gəlir</option>
                            <option value="expense">Xərc</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="category-name">Kateqoriya adı</label>
                        <input type="text" id="category-name" placeholder="Kateqoriya adını daxil edin" required>
                    </div>

                    <div class="form-group">
                        <button type="submit" class="btn">Kateqoriya əlavə et</button>
                    </div>
                </form>

                <div class="categories-list" id="categories-list">
                    <!-- Kateqoriyalar burada yerləşəcək -->
                </div>
            </div>
            
            <div class="tab-content" id="reservations">
                <div class="page-header">
                    <h1 class="page-title">Rezervasiya Təqvimi</h1>
                    <div>
                        <button class="btn" id="add-reservation-btn">Rezervasiya əlavə et</button>
                        <button class="btn" id="add-group-reservation-btn">Qrup rezervasiyası əlavə et</button>
                    </div>
                </div>

                <div class="timeline-container">
                    <div class="timeline-header">
                        <div class="filter-controls">
                            <select id="roomTypeFilter" class="form-select">
                                <option value="">Bütün Otaq Növləri</option>
                                <option value="standart">Standart Otaq</option>
                                <option value="deluxe">Deluxe Otaq</option>
                                <option value="suit">Suit Otaq</option>
                            </select>
                            <select id="statusFilter" class="form-select">
                                <option value="">Bütün Statuslar</option>
                                <option value="1">Rezerv olunub ödəniş olunmuyub</option>
                                <option value="2">Rezerv olunub qismi ödəniş olunub</option>
                                <option value="3">Rezerv olunub tam ödəniş olunub</option>
                                <option value="4">Rezerv dəqiqləşdirilib</option>
                                <option value="5">Qonaq giriş edib tam ödəniş edib</option>
                                <option value="6">Qonaq giriş edib qismi ödəniş edib</option>
                                <option value="7">Qonaq giriş edib ödəniş etməyib</option>
                                <option value="8">Qonaq gəlmədi</option>
                                <option value="9">Qonaq giriş edib çıxışda edib tam ödəniş edib</option>
                                <option value="10">Qonaq giriş edib çıxış edib ödəniş etməyib</option>
                                <option value="11">Qonaq giriş edib çıxış edib qismi ödəniş edib</option>
                                <option value="12">Qonaq giriş edib çıxış edib artıq ödəniş edib</option>
                            </select>
                        </div>
                        <div class="timeline-nav">
                            <span class="timeline-date-display" id="timeline-date-display"></span>
                            <button class="btn btn-outline" id="prev-week-timeline">←</button>
                            <button class="btn btn-outline" id="next-week-timeline">→</button>
                            <button class="btn btn-outline" id="today-btn-timeline">Bu gün</button>
                            <button class="btn" id="export-timeline">Excel Export</button>
                        </div>
                    </div>
                    
                    <div class="timeline-grid" id="timeline-grid">
                        <!-- Timeline will be generated by JavaScript -->
                    </div>
                </div>
            </div>

            <div class="tab-content" id="personal">
                <div class="container">
                    <div class="header">
                        <h1>Personal Sheet - İşçi Maaş İdarəetmə</h1>
                        <div>
                            <button id="exportExcelBtn" class="btn btn-success">Excel endir</button>
                            <button id="addEmployeeBtn" class="btn btn-primary">İşçi əlavə et</button>
                        </div>
                    </div>
                    
                    <div id="alertContainer"></div>
                    
<!-- Personal Management Timeline -->
<div class="timeline-container">
    <div class="timeline-header">
        <h2>İş günləri</h2>
        <div class="timeline-nav">
            <span class="timeline-date-display" id="currentMonth">Yanvar 2023</span>
            <button class="btn btn-outline" id="prev-week-personal">←</button>
            <button class="btn btn-outline" id="next-week-personal">→</button>
            <button class="btn btn-outline" id="today-btn-personal">Bu gün</button>
        </div>
    </div>
    
    <div class="timeline-grid" id="personal-timeline-grid">
        <!-- Timeline will be generated by JavaScript -->
    </div>
</div>
                    
                    <div class="salary-container">
                        <div class="salary-header">
                            <h2>Maaş hesablamaları</h2>
                            <button id="addSalaryBtn" class="btn btn-success">Maaş əlavə et</button>
                        </div>
                        
                        <table class="salary-table">
                            <thead>
                                <tr>
                                    <th>İşçi</th>
                                    <th>Maaş növü</th>
                                    <th>Ümumi maaş</th>
                                    <th>Avanslar</th>
                                    <th>Premyalar</th>
                                    <th>Alınan maaş</th>
                                    <th>Qalıq maaş</th>
                                    <th>Əməliyyat</th>
                                </tr>
                            </thead>
                            <tbody id="salaryTableBody">
                                <!-- Salary data will be populated by JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <!-- Add Employee Modal -->
                <div id="employeeModal" class="modal">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h3 class="modal-title">Yeni işçi əlavə et</h3>
                            <button class="close-btn" id="closeEmployeeModal">&times;</button>
                        </div>
                        <form id="employeeForm">
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="employeeName">Ad Soyad</label>
                                    <input type="text" id="employeeName" required>
                                </div>
                                <div class="form-group">
                                    <label for="employeePosition">Vəzifə</label>
                                    <input type="text" id="employeePosition" required>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label>Maaş növü</label>
                                <div style="display: flex; gap: 10px;">
                                    <label style="display: flex; align-items: center;">
                                        <input type="checkbox" id="monthlySalaryCheck" checked> Aylıq
                                    </label>
                                    <label style="display: flex; align-items: center;">
                                        <input type="checkbox" id="dailySalaryCheck"> Gündəlik
                                    </label>
                                </div>
                            </div>
                            
                            <div class="form-row" id="monthlySalaryGroup">
                                <div class="form-group">
                                    <label for="monthlySalaryAmount">Aylıq maaş (₼)</label>
                                    <input type="number" id="monthlySalaryAmount">
                                </div>
                            </div>
                            
                            <div class="form-row" id="dailySalaryGroup" style="display: none;">
                                <div class="form-group">
                                    <label for="dailySalaryAmount">Gündəlik maaş (₼)</label>
                                    <input type="number" id="dailySalaryAmount">
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label for="employeePhone">Telefon</label>
                                <input type="tel" id="employeePhone">
                            </div>
                            
                            <div class="modal-footer">
                                <button type="button" id="cancelEmployeeBtn" class="btn btn-danger">İmtina</button>
                                <button type="submit" class="btn btn-primary">Yadda saxla</button>
                            </div>
                        </form>
                    </div>
                </div>
                
                <!-- Add Salary Modal -->
                <div id="salaryModal" class="modal">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h3 class="modal-title">Maaş əlavə et</h3>
                            <button class="close-btn" id="closeSalaryModal">&times;</button>
                        </div>
                        <form id="salaryForm">
                            <div class="form-group">
                                <label for="salaryEmployee">İşçi</label>
                                <select id="salaryEmployee" required>
                                    <option value="">Seçin</option>
                                    <!-- Employees will be populated by JavaScript -->
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label for="salaryPaymentType">Ödəniş növü</label>
                                <select id="salaryPaymentType" required>
                                    <option value="">Seçin</option>
                                    <option value="salary">Maaş</option>
                                    <option value="advance">Avans</option>
                                    <option value="bonus">Premya</option>
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label for="salaryPaymentAmount">Məbləğ (₼)</label>
                                <input type="number" id="salaryPaymentAmount" required>
                            </div>
                            
                            <div class="form-group">
                                <label for="salaryPaymentDate">Tarix</label>
                                <input type="date" id="salaryPaymentDate" required>
                            </div>
                            
                            <div class="form-group">
                                <label for="salaryPaymentNote">Qeyd</label>
                                <input type="text" id="salaryPaymentNote">
                            </div>
                            
                            <div class="modal-footer">
                                <button type="button" id="cancelSalaryBtn" class="btn btn-danger">İmtina</button>
                                <button type="submit" class="btn btn-primary">Yadda saxla</button>
                            </div>
                        </form>
                    </div>
                </div>
                
                <!-- Edit Salary Modal -->
                <div id="editSalaryModal" class="modal">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h3 class="modal-title">Maaş redaktə et</h3>
                            <button class="close-btn" id="closeEditSalaryModal">&times;</button>
                        </div>
                        <form id="editSalaryForm">
                            <input type="hidden" id="editPaymentId">
                            <div class="form-group">
                                <label for="editSalaryEmployee">İşçi</label>
                                <input type="text" id="editSalaryEmployee" disabled>
                            </div>
                            
                            <div class="form-group">
                                <label for="editSalaryPaymentType">Ödəniş növü</label>
                                <select id="editSalaryPaymentType" required>
                                    <option value="salary">Maaş</option>
                                    <option value="advance">Avans</option>
                                    <option value="bonus">Premya</option>
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label for="editSalaryPaymentAmount">Məbləğ (₼)</label>
                                <input type="number" id="editSalaryPaymentAmount" required>
                            </div>
                            
                            <div class="form-group">
                                <label for="editSalaryPaymentDate">Tarix</label>
                                <input type="date" id="editSalaryPaymentDate" required>
                            </div>
                            
                            <div class="form-group">
                                <label for="editSalaryPaymentNote">Qeyd</label>
                                <input type="text" id="editSalaryPaymentNote">
                            </div>
                            
                            <div class="modal-footer">
                                <button type="button" id="cancelEditSalaryBtn" class="btn btn-danger">İmtina</button>
                                <button type="submit" class="btn btn-primary">Yadda saxla</button>
                                <button type="button" id="deleteSalaryBtn" class="btn btn-warning">Sil</button>
                            </div>
                        </form>
                    </div>
                </div>
            
            </div>
        </div>
    </div>

    <!-- Rezervasiya gəlirləri üçün modal -->
    <div class="modal" id="reservationIncomeModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Rezervasiya gəlirləri</h3>
                <button class="close-btn" id="close-reservation-income-modal">&times;</button>
            </div>
            <div class="reservation-income">
                <div id="reservation-income-details">
                    <!-- Rezervasiya gəlirləri burada yerləşəcək -->
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" id="cancel-reservation-income">Bağla</button>
            </div>
        </div>
    </div>

    <!-- Reservation Modal -->
    <div class="modal" id="reservationModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modal-title">Yeni Rezervasiya</h3>
                <button class="close-btn" id="close-modal">&times;</button>
            </div>
            <form id="reservation-form">
                <input type="hidden" id="reservation-id">
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Ad Soyad</label>
                        <input type="text" class="form-control" id="guest-name" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">ŞV/Passport</label>
                        <input type="text" class="form-control" id="guest-id">
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Telefon</label>
                        <input type="tel" class="form-control" id="guest-phone">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Şirkət</label>
                        <input type="text" class="form-control" id="guest-company">
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Otaq Növü</label>
                        <select class="form-select" id="room-type" required>
                            <option value="">Seçin</option>
                            <option value="standart">Standart Otaq</option>
                            <option value="deluxe">Deluxe Otaq</option>
                            <option value="suit">Suit Otaq</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Otaq No</label>
                        <input type="text" class="form-control" id="room-number" required readonly>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Giriş Tarixi</label>
                        <input type="date" class="form-control" id="checkin-date" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Çıxış Tarixi</label>
                        <input type="date" class="form-control" id="checkout-date" required>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Gecəlik Qiymət (₼)</label>
                        <input type="number" class="form-control" id="nightly-rate" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Gecə Sayı</label>
                        <input type="number" class="form-control" id="nights-count" readonly>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Ümumi Məbləğ (₼)</label>
                        <input type="number" class="form-control" id="total-amount" readonly>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Ödənilən Məbləğ (₼)</label>
                        <input type="number" class="form-control" id="paid-amount" readonly>
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Ödəniş Üsulu</label>
                    <div id="payment-methods-container">
                        <label class="payment-method">
                            <input type="checkbox" name="payment-method" value="cash">
                            <span class="payment-icon cash"></span> Nağd
                            <input type="number" class="payment-amount" placeholder="Məbləğ" data-method="cash">
                        </label>
                        <label class="payment-method">
                            <input type="checkbox" name="payment-method" value="kart">
                            <span class="payment-icon kart"></span> Kart-to-kart
                            <input type="number" class="payment-amount" placeholder="Məbləğ" data-method="kart">
                        </label>
                        <label class="payment-method">
                            <input type="checkbox" name="payment-method" value="xalqbank">
                            <span class="payment-icon xalqbank"></span> Xalqbank terminalı
                            <input type="number" class="payment-amount" placeholder="Məbləğ" data-method="xalqbank">
                        </label>
                        <label class="payment-method">
                            <input type="checkbox" name="payment-method" value="rabitabank">
                            <span class="payment-icon rabitabank"></span> Rabitəbank terminalı
                            <input type="number" class="payment-amount" placeholder="Məbləğ" data-method="rabitabank">
                        </label>
                        <label class="payment-method">
                            <input type="checkbox" name="payment-method" value="bank">
                            <span class="payment-icon bank"></span> Bank köçürməsi
                            <input type="number" class="payment-amount" placeholder="Məbləğ" data-method="bank">
                        </label>
                    </div>
                </div>
                
                <div class="booking-checkbox">
                    <label>
                        <input type="checkbox" id="is-booking"> Booking-dən
                    </label>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Qeydlər</label>
                    <textarea class="form-control" id="reservation-notes" rows="2"></textarea>
                </div>
                
                <div class="status-actions">
                    <button type="button" class="btn" id="checkin-btn">Qonaq giriş etdi</button>
                    <button type="button" class="btn btn-red" id="checkout-btn">Qonaq çıxış etdi</button>
                    <button type="button" class="btn btn-outline" id="no-show-btn">Qonaq gəlmədi</button>
                    <button type="button" class="btn" id="confirm-btn">Rezervasiya dəqiqləşdirildi</button>
                </div>
                
                <div class="reservation-details">
                    <h4>Rezervasiya Detalları</h4>
                    <p><strong>Status:</strong> <span id="detail-status">-</span></p>
                    <p><strong>Ümumi Məbləğ:</strong> <span id="detail-total-amount">0</span> ₼</p>
                    <p><strong>Ödənilib:</strong> <span id="detail-paid-amount">0</span> ₼</p>
                    <p><strong>Qalıq:</strong> <span id="detail-balance">0</span> ₼</p>
                    <p><strong>Giriş etdi:</strong> <span id="detail-checked-in">Xeyr</span></p>
                    <p><strong>Çıxış etdi:</strong> <span id="detail-checked-out">Xeyr</span></p>
                    <p><strong>Gəlmədi:</strong> <span id="detail-no-show">Xeyr</span></p>
                    <p><strong>Dəqiqləşdirildi:</strong> <span id="detail-confirmed">Xeyr</span></p>
                </div>
                
                <div id="current-status" class="current-status"></div>
                
                <div class="reservation-summary">
                    <h4>Rezervasiya Məlumatları</h4>
                    <div class="summary-item"><strong>Giriş:</strong> <span id="summary-checkin">-</span></div>
                    <div class="summary-item"><strong>Çıxış:</strong> <span id="summary-checkout">-</span></div>
                    <div class="summary-item"><strong>Otaq:</strong> <span id="summary-room">-</span></div>
                    <div class="summary-item"><strong>Qonaq:</strong> <span id="summary-guest">-</span></div>
                    <div class="summary-item"><strong>Ümumi Məbləğ:</strong> <span id="summary-total">-</span></div>
                    <div class="summary-item"><strong>Ödənilib:</strong> <span id="summary-paid">-</span></div>
                    <div class="summary-item"><strong>Ödəniş üsulu:</strong> <span id="summary-payment-methods">-</span></div>
                </div>
                
                <div class="modal-footer">
                    <button type="button" class="btn btn-red" id="delete-reservation-btn">Rezervasiyanı sil</button>
                    <button type="button" class="btn btn-outline" id="generate-confirmation-btn">Confirmation yarat</button>
                    <button type="button" class="btn btn-outline" id="generate-invoice-btn">Invoice yarat</button>
                    <button type="button" class="btn btn-outline" id="generate-registration-btn">Qeydiyyat blankı yarat</button>
                    <button type="button" class="btn btn-outline" id="cancel-reservation">İmtina</button>
                    <button type="submit" class="btn" id="save-reservation">Yadda Saxla</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Group Reservation Modal -->
    <div class="modal" id="groupReservationModal">
        <div class="modal-content group-modal-content">
            <div class="modal-header">
                <h3>Qrup Rezervasiyası</h3>
                <button class="close-btn" id="close-group-modal">&times;</button>
            </div>
            <form id="group-reservation-form">
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Giriş Tarixi</label>
                        <input type="date" class="form-control" id="group-checkin-date" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Çıxış Tarixi</label>
                        <input type="date" class="form-control" id="group-checkout-date" required>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Şirkət</label>
                        <input type="text" class="form-control" id="group-company">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Otaq Növü</label>
                        <select class="form-select" id="group-room-type">
                            <option value="">Bütün Otaq Növləri</option>
                            <option value="standart">Standart Otaq</option>
                            <option value="deluxe">Deluxe Otaq</option>
                            <option value="suit">Suit Otaq</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Gecəlik Qiymət (₼)</label>
                    <input type="number" class="form-control" id="group-nightly-rate" required>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Boş Otaqlar</label>
                    <div class="group-rooms-grid" id="available-rooms-grid">
                        <!-- Available rooms will be loaded here -->
                    </div>
                </div>
                
                <button type="button" class="btn btn-outline group-invoice-btn" id="generate-group-invoice-btn">Qrup üçün Invoice yarat</button>
                
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline" id="cancel-group-reservation">İmtina</button>
                    <button type="submit" class="btn" id="save-group-reservation">Rezervasiyaları Yarat</button>
                </div>
            </form>
        </div>
    </div>
<script src="script.js"></script>
<script>
    // Məlumatların saxlanması
let transactions = JSON.parse(localStorage.getItem('hotelTransactions')) || [];
let categories = JSON.parse(localStorage.getItem('hotelCategories')) || [
    { id: 1, type: 'income', name: 'Otaq rezervasiyası' },
    { id: 2, type: 'income', name: 'Restoran' },
    { id: 3, type: 'income', name: 'SPA' },
    { id: 4, type: 'expense', name: 'Əmək haqqı' },
    { id: 5, type: 'expense', name: 'Kommunal xidmətlər' },
    { id: 6, type: 'expense', name: 'Təmir' }
    
];

// Rezervasiya gəlirləri (nümunə məlumat)
let reservationIncomes = JSON.parse(localStorage.getItem('hotelReservationIncomes')) || [];

// Personal management data
let employees = JSON.parse(localStorage.getItem('employees')) || [];
let workDays = JSON.parse(localStorage.getItem('workDays')) || {};
let salaryPayments = JSON.parse(localStorage.getItem('salaryPayments')) || [];
let salaryPaymentDates = JSON.parse(localStorage.getItem('salaryPaymentDates')) || {};

// Reservation Data and Configuration
const rooms = [
    { number: '101', type: 'standart', capacity: 2 },
    { number: '102', type: 'standart', capacity: 3 },
    { number: '103', type: 'standart', capacity: 2 },
    { number: '104', type: 'standart', capacity: 2 },
    { number: '201', type: 'deluxe', capacity: 2 },
    { number: '202', type: 'standart', capacity: 2 },
    { number: '203', type: 'standart', capacity: 3 },
    { number: '204', type: 'standart', capacity: 3 },
    { number: '205', type: 'standart', capacity: 2 },
    { number: '206', type: 'standart', capacity: 2 },
    { number: '301', type: 'deluxe', capacity: 2 },
    { number: '302', type: 'suit', capacity: 4 },
    { number: '501', type: 'standart', capacity: 3 },
    { number: '502', type: 'standart', capacity: 3 }
];

let reservations = JSON.parse(localStorage.getItem('hotelReservations')) || [
    {
        id: generateReservationId(),
        guestName: "Əli Hüseynov",
        guestId: "AZE1234567",
        phone: "+994501234567",
        company: "ABC Şirkəti",
        roomNumber: "101",
        roomType: "standart",
        checkInDate: new Date(Date.now() - 86400000 * 2).toISOString().split('T')[0],
        checkOutDate: new Date(Date.now() + 86400000 * 2).toISOString().split('T')[0],
        nightlyRate: 80,
        totalAmount: 320,
        paidAmount: 320,
        paymentMethods: [{ method: "cash", amount: 320 }],
        status: 5,
        checkedIn: true,
        checkedOut: true,
        noShow: false,
        isBooking: false,
        confirmed: false,
        notes: ""
    }
];

const statusDefinitions = [
    { id: 1, name: 'Rezerv olunub ödəniş olunmuyub', color: '#FFEB3B' },
    { id: 2, name: 'Rezerv olunub qismi ödəniş olunub', color: '#8BC34A' },
    { id: 3, name: 'Rezerv olunub tam ödəniş olunub', color: '#4CAF50' },
    { id: 4, name: 'Rezerv dəqiqləşdirilib', color: '#00BCD4' },
    { id: 5, name: 'Qonaq giriş edib tam ödəniş edib', color: '#2196F3' },
    { id: 6, name: 'Qonaq giriş edib qismi ödəniş edib', color: '#64B5F6' },
    { id: 7, name: 'Qonaq giriş edib ödəniş etməyib', color: '#FF9800' },
    { id: 8, name: 'Qonaq gəlmədi', color: '#F44336' },
    { id: 9, name: 'Qonaq giriş edib çıxışda edib tam ödəniş edib', color: '#388E3C' },
    { id: 10, name: 'Qonaq giriş edib çıxış edib ödəniş etməyib', color: '#D32F2F' },
    { id: 11, name: 'Qonaq giriş edib çıxış edib qismi ödəniş edib', color: '#FFA000' },
    { id: 12, name: 'Qonaq giriş edib çıxış edib artıq ödəniş edib', color: '#7B1FA2' }
];


async function generateConfirmation(reservation) {
    if (!reservation) {
        showAlert('danger', 'Xəta: Rezervasiya tapılmadı');
        return null;
    }

    const workbook = new ExcelJS.Workbook();
    const worksheet = workbook.addWorksheet('Confirmation');
    
    // Sütun enləri (2. sütun daha geniş)
    worksheet.columns = [
        { width: 25 }, { width: 35 }, { width: 12 }, 
        { width: 15 }, { width: 20 }
    ];
    
    // Stiller
    const titleStyle = {
        font: { bold: true, size: 14, color: { argb: 'FF000000' } },
        alignment: { vertical: 'middle', horizontal: 'center' },
        fill: { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFD9D9D9' } }
    };
    
    const headerStyle = {
        font: { bold: true, color: { argb: 'FFFFFFFF' } },
        fill: { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FF6D5ACD' } },
        border: {
            top: { style: 'thin', color: { argb: 'FF000000' } },
            left: { style: 'thin', color: { argb: 'FF000000' } },
            right: { style: 'thin', color: { argb: 'FF000000' } },
            bottom: { style: 'thin', color: { argb: 'FF000000' } }
        }
    };
    
    const borderedStyle = {
        border: {
            top: { style: 'thin', color: { argb: 'FF000000' } },
            left: { style: 'thin', color: { argb: 'FF000000' } },
            right: { style: 'thin', color: { argb: 'FF000000' } },
            bottom: { style: 'thin', color: { argb: 'FF000000' } }
        }
    };
    
    const paymentStyle = {
        fill: { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFE6E6FA' } },
        border: {
            top: { style: 'thin', color: { argb: 'FF000000' } },
            left: { style: 'thin', color: { argb: 'FF000000' } },
            right: { style: 'thin', color: { argb: 'FF000000' } },
            bottom: { style: 'thin', color: { argb: 'FF000000' } }
        }
    };

    // Otel başlığı
    worksheet.mergeCells('A1:E1');
    worksheet.getCell('A1').value = "MinAli Boutique Hotel";
    worksheet.getCell('A1').style = titleStyle;
    
    // Rezervasiya təsdiqi başlığı
    worksheet.mergeCells('A3:E3');
    worksheet.getCell('A3').value = "REZERVASİYA TƏSDİQİ";
    worksheet.getCell('A3').style = titleStyle;
    
    // Rezervasiya məlumatları
    const details = [
        ["Rezervasiya №:", reservation.id],
        ["Qonaq adı:", reservation.guestName],
        ["Şirkət:", reservation.company || '-'],
        ["Otaq nömrəsi:", reservation.roomNumber],
        ["Otaq növü:", getRoomTypeName(reservation.roomType)],
        ["Giriş tarixi:", `${formatDate(reservation.checkInDate)} (14:00-dan sonra)`],
        ["Çıxış tarixi:", `${formatDate(reservation.checkOutDate)} (12:00-a qədər)`],
        ["Gecə sayı:", calculateNights(reservation.checkInDate, reservation.checkOutDate)],
        ["Ümumi məbləğ:", `${reservation.totalAmount} ₼`],
        ["Ödənilib:", `${reservation.paidAmount} ₼`],
        ["Qalıq:", `${(reservation.totalAmount - reservation.paidAmount).toFixed(2)} ₼`]
    ];
    
    // Detalları ekle
    details.forEach(([label, value], index) => {
        const row = 5 + index;
        worksheet.getCell(`A${row}`).value = label;
        worksheet.getCell(`A${row}`).style = borderedStyle;
        
        worksheet.getCell(`B${row}`).value = value;
        worksheet.getCell(`B${row}`).style = borderedStyle;
        
        // Birleştirilmiş hücreler
        if (index > 7) {
            worksheet.mergeCells(`B${row}:E${row}`);
        }
    });
    
    // Ödəniş üsulları başlığı
    const paymentHeaderRow = 5 + details.length + 1;
    worksheet.mergeCells(`A${paymentHeaderRow}:E${paymentHeaderRow}`);
    worksheet.getCell(`A${paymentHeaderRow}`).value = "ÖDƏNİŞ ÜSULLARI";
    worksheet.getCell(`A${paymentHeaderRow}`).style = headerStyle;
    
    // Ödəniş üsulları
    reservation.paymentMethods.forEach((payment, index) => {
        const row = paymentHeaderRow + 1 + index;
        worksheet.getCell(`A${row}`).value = `${payment.method}:`;
        worksheet.getCell(`A${row}`).style = paymentStyle;
        
        worksheet.getCell(`B${row}`).value = `${payment.amount} ₼`;
        worksheet.getCell(`B${row}`).style = paymentStyle;
        
        worksheet.mergeCells(`B${row}:E${row}`);
    });
    
    // Bank məlumatları
    const bankRow = paymentHeaderRow + reservation.paymentMethods.length + 2;
    worksheet.mergeCells(`A${bankRow}:E${bankRow}`);
    worksheet.getCell(`A${bankRow}`).value = "BANK MƏLUMATLARI";
    worksheet.getCell(`A${bankRow}`).style = headerStyle;
    
    const bankDetails = [
        ["Hesab №:", "AZ49HAJCSCRAZN01910152897001"],
        ["Bank adı:", "ASC 'Xalq' Bankın 'Şəki' filialı"],
        ["VÖEN:", "3000322242"]
    ];
    
    bankDetails.forEach(([label, value], index) => {
        const row = bankRow + 1 + index;
        worksheet.getCell(`A${row}`).value = label;
        worksheet.getCell(`A${row}`).style = borderedStyle;
        
        worksheet.getCell(`B${row}`).value = value;
        worksheet.getCell(`B${row}`).style = borderedStyle;
        
        worksheet.mergeCells(`B${row}:E${row}`);
    });
    
    // İmza sahəsi
    const signRow = bankRow + bankDetails.length + 2;
    worksheet.mergeCells(`A${signRow}:E${signRow}`);
    worksheet.getCell(`A${signRow}`).value = "Tarix: ___________________   İmza: ___________________";
    worksheet.getCell(`A${signRow}`).style = { alignment: { horizontal: 'right' } };
    
    // Excel faylını yarat və yüklə
    const buffer = await workbook.xlsx.writeBuffer();
    const fileName = `Rezervasiya_Tesdiqi_${reservation.id}.xlsx`;
    
    saveAs(new Blob([buffer]), fileName);
    showAlert('success', 'Rezervasiya təsdiqi uğurla yaradıldı və endirildi');
    
    return true;
}

async function generateInvoice(reservation) {
    if (!reservation) {
        showAlert('danger', 'Xəta: Rezervasiya tapılmadı');
        return null;
    }

    if (reservation.paidAmount <= 0) {
        showAlert('warning', 'Xəbərdarlıq: Invoice yalnız ödəniş olunan rezervasiyalar üçün yaradıla bilər');
        return null;
    }
    
    const workbook = new ExcelJS.Workbook();
    const worksheet = workbook.addWorksheet('Invoice');
    
    // Sütun enləri (2. sütun daha geniş)
    worksheet.columns = [
        { width: 25 }, { width: 35 }, { width: 12 }, 
        { width: 15 }, { width: 20 }
    ];
    
    // Stiller
    const titleStyle = {
        font: { bold: true, size: 14, color: { argb: 'FF000000' } },
        alignment: { vertical: 'middle', horizontal: 'center' },
        fill: { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFD9D9D9' } }
    };
    
    const headerStyle = {
        font: { bold: true, color: { argb: 'FFFFFFFF' } },
        fill: { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FF4361EE' } },
        border: {
            top: { style: 'thin', color: { argb: 'FF000000' } },
            left: { style: 'thin', color: { argb: 'FF000000' } },
            right: { style: 'thin', color: { argb: 'FF000000' } },
            bottom: { style: 'thin', color: { argb: 'FF000000' } }
        }
    };
    
    const borderedStyle = {
        border: {
            top: { style: 'thin', color: { argb: 'FF000000' } },
            left: { style: 'thin', color: { argb: 'FF000000' } },
            right: { style: 'thin', color: { argb: 'FF000000' } },
            bottom: { style: 'thin', color: { argb: 'FF000000' } }
        }
    };
    
    const totalStyle = {
        fill: { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFE6E6FA' } },
        border: {
            top: { style: 'thin', color: { argb: 'FF000000' } },
            left: { style: 'thin', color: { argb: 'FF000000' } },
            right: { style: 'thin', color: { argb: 'FF000000' } },
            bottom: { style: 'thin', color: { argb: 'FF000000' } }
        },
        font: { bold: true }
    };

    // Otel başlığı
    worksheet.mergeCells('A1:E1');
    worksheet.getCell('A1').value = "MinAli Boutique Hotel";
    worksheet.getCell('A1').style = titleStyle;
    
    // Invoice başlığı
    worksheet.mergeCells('A3:E3');
    worksheet.getCell('A3').value = "HESAB-FAKTURA";
    worksheet.getCell('A3').style = titleStyle;
    
    // Invoice məlumatları
    const invoiceDetails = [
        ["Invoice №:", `INV-${Date.now().toString().slice(-6)}`],
        ["Tarix:", formatDate(new Date().toISOString().split('T')[0])],
        ["Rezervasiya №:", reservation.id],
        ["Qonaq adı:", reservation.guestName],
        ["Şirkət:", reservation.company || '-'],
        ["Otaq nömrəsi:", reservation.roomNumber],
        ["Otaq növü:", getRoomTypeName(reservation.roomType)],
        ["Giriş tarixi:", formatDate(reservation.checkInDate)],
        ["Çıxış tarixi:", formatDate(reservation.checkOutDate)],
        ["Gecə sayı:", calculateNights(reservation.checkInDate, reservation.checkOutDate)],
        ["Ümumi məbləğ:", `${reservation.totalAmount} ₼`],
        ["Ödənilib:", `${reservation.paidAmount} ₼`],
        ["Qalıq:", `${(reservation.totalAmount - reservation.paidAmount).toFixed(2)} ₼`]
    ];
    
    // Detalları ekle
    invoiceDetails.forEach(([label, value], index) => {
        const row = 5 + index;
        worksheet.getCell(`A${row}`).value = label;
        worksheet.getCell(`A${row}`).style = borderedStyle;
        
        worksheet.getCell(`B${row}`).value = value;
        worksheet.getCell(`B${row}`).style = borderedStyle;
        
        // Birleştirilmiş hücreler
        if (index > 9) {
            worksheet.mergeCells(`B${row}:E${row}`);
            worksheet.getCell(`A${row}`).style = totalStyle;
            worksheet.getCell(`B${row}`).style = totalStyle;
        }
    });
    
    // Ödəniş üsulları başlığı
    const paymentHeaderRow = 5 + invoiceDetails.length + 1;
    worksheet.mergeCells(`A${paymentHeaderRow}:E${paymentHeaderRow}`);
    worksheet.getCell(`A${paymentHeaderRow}`).value = "ÖDƏNİŞ ÜSULLARI";
    worksheet.getCell(`A${paymentHeaderRow}`).style = headerStyle;
    
    // Ödəniş üsulları
    reservation.paymentMethods.forEach((payment, index) => {
        const row = paymentHeaderRow + 1 + index;
        worksheet.getCell(`A${row}`).value = `${payment.method}:`;
        worksheet.getCell(`A${row}`).style = borderedStyle;
        
        worksheet.getCell(`B${row}`).value = `${payment.amount} ₼`;
        worksheet.getCell(`B${row}`).style = borderedStyle;
        
        worksheet.mergeCells(`B${row}:E${row}`);
    });
    
    // Bank məlumatları
    const bankRow = paymentHeaderRow + reservation.paymentMethods.length + 2;
    worksheet.mergeCells(`A${bankRow}:E${bankRow}`);
    worksheet.getCell(`A${bankRow}`).value = "BANK MƏLUMATLARI";
    worksheet.getCell(`A${bankRow}`).style = headerStyle;
    
    const bankDetails = [
        ["Hesab №:", "AZ49HAJCSCRAZN01910152897001"],
        ["Bank adı:", "ASC 'Xalq' Bankın 'Şəki' filialı"],
        ["VÖEN:", "3000322242"]
    ];
    
    bankDetails.forEach(([label, value], index) => {
        const row = bankRow + 1 + index;
        worksheet.getCell(`A${row}`).value = label;
        worksheet.getCell(`A${row}`).style = borderedStyle;
        
        worksheet.getCell(`B${row}`).value = value;
        worksheet.getCell(`B${row}`).style = borderedStyle;
        
        worksheet.mergeCells(`B${row}:E${row}`);
    });
    
    // İmza sahəsi
    const signRow = bankRow + bankDetails.length + 2;
    worksheet.mergeCells(`A${signRow}:E${signRow}`);
    worksheet.getCell(`A${signRow}`).value = "Tarix: ___________________   İmza: ___________________";
    worksheet.getCell(`A${signRow}`).style = { alignment: { horizontal: 'right' } };
    
    // Excel faylını yarat və yüklə
    const buffer = await workbook.xlsx.writeBuffer();
    const fileName = `Invoice_${reservation.id}.xlsx`;
    
    saveAs(new Blob([buffer]), fileName);
    showAlert('success', 'Invoice uğurla yaradıldı və endirildi');
    
    return true;
}

async function generateRegistrationForm(reservation) {
    if (!reservation) {
        showAlert('danger', 'Xəta: Rezervasiya tapılmadı');
        return null;
    }

    const workbook = new ExcelJS.Workbook();
    const worksheet = workbook.addWorksheet('Qeydiyyat Blankı');
    
    // Sütun enləri (2. sütun daha geniş)
    worksheet.columns = [
        { width: 25 }, { width: 35 }, { width: 12 }, 
        { width: 15 }, { width: 20 }
    ];
    
    // Stiller
    const titleStyle = {
        font: { bold: true, size: 14, color: { argb: 'FF000000' } },
        alignment: { vertical: 'middle', horizontal: 'center' },
        fill: { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFD9D9D9' } }
    };
    
    const headerStyle = {
        font: { bold: true, color: { argb: 'FFFFFFFF' } },
        fill: { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FF2ED573' } },
        border: {
            top: { style: 'thin', color: { argb: 'FF000000' } },
            left: { style: 'thin', color: { argb: 'FF000000' } },
            right: { style: 'thin', color: { argb: 'FF000000' } },
            bottom: { style: 'thin', color: { argb: 'FF000000' } }
        }
    };
    
    const borderedStyle = {
        border: {
            top: { style: 'thin', color: { argb: 'FF000000' } },
            left: { style: 'thin', color: { argb: 'FF000000' } },
            right: { style: 'thin', color: { argb: 'FF000000' } },
            bottom: { style: 'thin', color: { argb: 'FF000000' } }
        }
    };
    
    const rulesStyle = {
        font: { italic: true },
        border: {
            top: { style: 'thin', color: { argb: 'FF000000' } },
            left: { style: 'thin', color: { argb: 'FF000000' } },
            right: { style: 'thin', color: { argb: 'FF000000' } },
            bottom: { style: 'thin', color: { argb: 'FF000000' } }
        },
        fill: { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFF0F8FF' } }
    };

    // Otel başlığı
    worksheet.mergeCells('A1:E1');
    worksheet.getCell('A1').value = "MinAli Boutique Hotel";
    worksheet.getCell('A1').style = titleStyle;
    
    // Qeydiyyat blankı başlığı
    worksheet.mergeCells('A3:E3');
    worksheet.getCell('A3').value = "QONAQ QEYDİYYAT VƏ RAZILAŞMA FORMASI";
    worksheet.getCell('A3').style = titleStyle;
    
    // Qonaq məlumatları
    const guestDetails = [
        ["Ad Soyad:", reservation.guestName],
        ["Şəxsiyyət vəsiqəsi/Passport:", reservation.guestId || '-'],
        ["Telefon:", reservation.phone || '-'],
        ["Şirkət:", reservation.company || '-']
    ];
    
    // Qonaq məlumatlarını ekle
    guestDetails.forEach(([label, value], index) => {
        const row = 5 + index;
        worksheet.getCell(`A${row}`).value = label;
        worksheet.getCell(`A${row}`).style = borderedStyle;
        
        worksheet.getCell(`B${row}`).value = value;
        worksheet.getCell(`B${row}`).style = borderedStyle;
        
        worksheet.mergeCells(`B${row}:E${row}`);
    });
    
    // Rezervasiya məlumatları başlığı
    const reservationHeaderRow = 5 + guestDetails.length + 1;
    worksheet.mergeCells(`A${reservationHeaderRow}:E${reservationHeaderRow}`);
    worksheet.getCell(`A${reservationHeaderRow}`).value = "REZERVASİYA MƏLUMATLARI";
    worksheet.getCell(`A${reservationHeaderRow}`).style = headerStyle;
    
    // Rezervasiya məlumatları
    const reservationDetails = [
        ["Otaq nömrəsi:", reservation.roomNumber],
        ["Otaq növü:", getRoomTypeName(reservation.roomType)],
        ["Giriş tarixi:", `${formatDate(reservation.checkInDate)} (14:00-dan sonra)`],
        ["Çıxış tarixi:", `${formatDate(reservation.checkOutDate)} (12:00-a qədər)`],
        ["Gecə sayı:", calculateNights(reservation.checkInDate, reservation.checkOutDate)],
        ["Ümumi məbləğ:", `${reservation.totalAmount} ₼`]
    ];
    
    reservationDetails.forEach(([label, value], index) => {
        const row = reservationHeaderRow + 1 + index;
        worksheet.getCell(`A${row}`).value = label;
        worksheet.getCell(`A${row}`).style = borderedStyle;
        
        worksheet.getCell(`B${row}`).value = value;
        worksheet.getCell(`B${row}`).style = borderedStyle;
        
        worksheet.mergeCells(`B${row}:E${row}`);
    });
    
    // Otel qaydaları başlığı
    const rulesHeaderRow = reservationHeaderRow + reservationDetails.length + 1;
    worksheet.mergeCells(`A${rulesHeaderRow}:E${rulesHeaderRow}`);
    worksheet.getCell(`A${rulesHeaderRow}`).value = "OTEL QAYDALARI";
    worksheet.getCell(`A${rulesHeaderRow}`).style = headerStyle;
    
    // Otel qaydaları
    const rules = [
        "1. Check-in saat 14:00, check-out saat 12:00-dır.",
        "2. Otel ərazisində siqaret çəkmək qadağandır.",
        "3. Otaqlarda və ümumi ərazilərdə səs-küy etmək qadağandır.",
        "4. Qiymətə səhər yeməyi daxildir (08:00-10:00).",
        "5. Əşyaların itkisi və ya zədələnməsi üçün otel məsuliyyət daşımır.",
        "6. Qonaq otaqda dəyərli əşyalar qoyub getdikdə, otel inzibati işçilərinə xəbər verməlidir.",
        "7. Qonaq otaq açarını itirdikdə, cərimə ödəməlidir.",
        "8. Qonaq otel ərazisində qanunvericiliyə zidd hərəkətlər etdikdə, otel inzibati işçiləri polisə xəbər verə bilər."
    ];
    
    rules.forEach((rule, index) => {
        const row = rulesHeaderRow + 1 + index;
        worksheet.mergeCells(`A${row}:E${row}`);
        worksheet.getCell(`A${row}`).value = rule;
        worksheet.getCell(`A${row}`).style = rulesStyle;
    });
    
    // Razılaşma mətni
    const agreementRow = rulesHeaderRow + rules.length + 1;
    worksheet.mergeCells(`A${agreementRow}:E${agreementRow}`);
    worksheet.getCell(`A${agreementRow}`).value = "Yuxarıda qeyd olunan qaydaları oxudum və qəbul edirəm. Otel ərazisində baş verə biləcək qanunsuz hərəkətlərimə görə məsuliyyəti öz üzərimə götürürəm.";
    worksheet.getCell(`A${agreementRow}`).style = { 
        font: { italic: true },
        alignment: { wrapText: true }
    };
    
    // İmza sahələri
    const signRow = agreementRow + 2;
    worksheet.getCell(`A${signRow}`).value = "Qonaq:";
    worksheet.getCell(`B${signRow}`).value = "Resepşn işçisi:";
    
    worksheet.getCell(`A${signRow+1}`).value = "_________________________";
    worksheet.getCell(`B${signRow+1}`).value = "_________________________";
    
    worksheet.getCell(`A${signRow+2}`).value = "İmza";
    worksheet.getCell(`A${signRow+2}`).style = { alignment: { horizontal: 'center' } };
    worksheet.getCell(`B${signRow+2}`).value = "İmza";
    worksheet.getCell(`B${signRow+2}`).style = { alignment: { horizontal: 'center' } };
    
    worksheet.getCell(`A${signRow+3}`).value = "Tarix: ___________________";
    worksheet.getCell(`B${signRow+3}`).value = "Tarix: ___________________";
    
    // Excel faylını yarat və yüklə
    const buffer = await workbook.xlsx.writeBuffer();
    const fileName = `Qeydiyyat_Blankı_${reservation.guestName.replace(/\s+/g, '_')}_${reservation.roomNumber}.xlsx`;
    
    saveAs(new Blob([buffer]), fileName);
    showAlert('success', 'Qeydiyyat blankı uğurla yaradıldı və endirildi');
    
    return true;
}

async function generateGroupInvoice(groupReservations) {
    if (!groupReservations || groupReservations.length === 0) {
        showAlert('danger', 'Xəta: Qrup rezervasiyaları tapılmadı');
        return null;
    }

    const workbook = new ExcelJS.Workbook();
    const worksheet = workbook.addWorksheet('Group Invoice');
    
    // Sütun enləri (2. sütun daha geniş)
    worksheet.columns = [
        { width: 25 }, { width: 35 }, { width: 12 }, 
        { width: 15 }, { width: 20 }
    ];
    
    // Stiller
    const titleStyle = {
        font: { bold: true, size: 14, color: { argb: 'FF000000' } },
        alignment: { vertical: 'middle', horizontal: 'center' },
        fill: { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFD9D9D9' } }
    };
    
    const headerStyle = {
        font: { bold: true, color: { argb: 'FFFFFFFF' } },
        fill: { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FF4361EE' } },
        border: {
            top: { style: 'thin', color: { argb: 'FF000000' } },
            left: { style: 'thin', color: { argb: 'FF000000' } },
            right: { style: 'thin', color: { argb: 'FF000000' } },
            bottom: { style: 'thin', color: { argb: 'FF000000' } }
        }
    };
    
    const borderedStyle = {
        border: {
            top: { style: 'thin', color: { argb: 'FF000000' } },
            left: { style: 'thin', color: { argb: 'FF000000' } },
            right: { style: 'thin', color: { argb: 'FF000000' } },
            bottom: { style: 'thin', color: { argb: 'FF000000' } }
        }
    };
    
    const roomStyle = {
        fill: { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFF0F8FF' } },
        border: {
            top: { style: 'thin', color: { argb: 'FF000000' } },
            left: { style: 'thin', color: { argb: 'FF000000' } },
            right: { style: 'thin', color: { argb: 'FF000000' } },
            bottom: { style: 'thin', color: { argb: 'FF000000' } }
        }
    };
    
    const totalStyle = {
        fill: { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFE6E6FA' } },
        border: {
            top: { style: 'thin', color: { argb: 'FF000000' } },
            left: { style: 'thin', color: { argb: 'FF000000' } },
            right: { style: 'thin', color: { argb: 'FF000000' } },
            bottom: { style: 'thin', color: { argb: 'FF000000' } }
        },
        font: { bold: true }
    };

    // Otel başlığı
    worksheet.mergeCells('A1:E1');
    worksheet.getCell('A1').value = "MinAli Boutique Hotel";
    worksheet.getCell('A1').style = titleStyle;
    
    // Qrup invoice başlığı
    worksheet.mergeCells('A3:E3');
    worksheet.getCell('A3').value = "QRUP HESAB-FAKTURASI";
    worksheet.getCell('A3').style = titleStyle;
    
    // Ümumi məlumatlar
    const generalDetails = [
        ["Invoice №:", `GRP-INV-${Date.now().toString().slice(-6)}`],
        ["Tarix:", formatDate(new Date().toISOString().split('T')[0])],
        ["Şirkət:", groupReservations[0].company || '-'],
        ["Giriş tarixi:", formatDate(groupReservations[0].checkInDate)],
        ["Çıxış tarixi:", formatDate(groupReservations[0].checkOutDate)],
        ["Gecə sayı:", calculateNights(groupReservations[0].checkInDate, groupReservations[0].checkOutDate)],
        ["Otaq sayı:", groupReservations.length]
    ];
    
    // Ümumi məlumatları ekle
    generalDetails.forEach(([label, value], index) => {
        const row = 5 + index;
        worksheet.getCell(`A${row}`).value = label;
        worksheet.getCell(`A${row}`).style = borderedStyle;
        
        worksheet.getCell(`B${row}`).value = value;
        worksheet.getCell(`B${row}`).style = borderedStyle;
        
        worksheet.mergeCells(`B${row}:E${row}`);
    });
    
    // Ümumi ödəniş məlumatları
    const totalAmount = groupReservations.reduce((sum, r) => sum + r.totalAmount, 0);
    const paidAmount = groupReservations.reduce((sum, r) => sum + r.paidAmount, 0);
    const balance = totalAmount - paidAmount;
    
    const paymentDetails = [
        ["Ümumi məbləğ:", `${totalAmount} ₼`],
        ["Ümumi ödənilib:", `${paidAmount} ₼`],
        ["Ümumi qalıq:", `${balance.toFixed(2)} ₼`]
    ];
    
    // Ümumi ödəniş məlumatlarını ekle
    paymentDetails.forEach(([label, value], index) => {
        const row = 5 + generalDetails.length + index;
        worksheet.getCell(`A${row}`).value = label;
        worksheet.getCell(`A${row}`).style = totalStyle;
        
        worksheet.getCell(`B${row}`).value = value;
        worksheet.getCell(`B${row}`).style = totalStyle;
        
        worksheet.mergeCells(`B${row}:E${row}`);
    });
    
    // Otaq detalları başlığı
    const roomsHeaderRow = 5 + generalDetails.length + paymentDetails.length + 1;
    worksheet.mergeCells(`A${roomsHeaderRow}:E${roomsHeaderRow}`);
    worksheet.getCell(`A${roomsHeaderRow}`).value = "OTAQLARIN DETALLARI";
    worksheet.getCell(`A${roomsHeaderRow}`).style = headerStyle;
    
    // Otaq detalları
    groupReservations.forEach((reservation, index) => {
        const row = roomsHeaderRow + 1 + index;
        worksheet.getCell(`A${row}`).value = `Otaq ${reservation.roomNumber}:`;
        worksheet.getCell(`A${row}`).style = roomStyle;
        
        worksheet.getCell(`B${row}`).value = `${reservation.totalAmount} ₼ (${getRoomTypeName(reservation.roomType)})`;
        worksheet.getCell(`B${row}`).style = roomStyle;
        
        worksheet.mergeCells(`B${row}:E${row}`);
    });
    
    // Bank məlumatları
    const bankRow = roomsHeaderRow + groupReservations.length + 2;
    worksheet.mergeCells(`A${bankRow}:E${bankRow}`);
    worksheet.getCell(`A${bankRow}`).value = "BANK MƏLUMATLARI";
    worksheet.getCell(`A${bankRow}`).style = headerStyle;
    
    const bankDetails = [
        ["Hesab №:", "AZ49HAJCSCRAZN01910152897001"],
        ["Bank adı:", "ASC 'Xalq' Bankın 'Şəki' filialı"],
        ["VÖEN:", "3000322242"]
    ];
    
    bankDetails.forEach(([label, value], index) => {
        const row = bankRow + 1 + index;
        worksheet.getCell(`A${row}`).value = label;
        worksheet.getCell(`A${row}`).style = borderedStyle;
        
        worksheet.getCell(`B${row}`).value = value;
        worksheet.getCell(`B${row}`).style = borderedStyle;
        
        worksheet.mergeCells(`B${row}:E${row}`);
    });
    
    // İmza sahəsi
    const signRow = bankRow + bankDetails.length + 2;
    worksheet.mergeCells(`A${signRow}:E${signRow}`);
    worksheet.getCell(`A${signRow}`).value = "Tarix: ___________________   İmza: ___________________";
    worksheet.getCell(`A${signRow}`).style = { alignment: { horizontal: 'right' } };
    
    // Excel faylını yarat və yüklə
    const buffer = await workbook.xlsx.writeBuffer();
    const fileName = `Group_Invoice_${Date.now().toString().slice(-6)}.xlsx`;
    
    saveAs(new Blob([buffer]), fileName);
    showAlert('success', 'Qrup invoice uğurla yaradıldı və endirildi');
    
    return true;
}

// Current date variables
let currentDate = new Date();
let currentWeekStart = new Date(currentDate);
currentWeekStart.setDate(currentDate.getDate() - currentDate.getDay());
let currentMonth = currentDate.getMonth();
let currentYear = currentDate.getFullYear();

// Səhifə yüklənəndə
document.addEventListener('DOMContentLoaded', function() {
    // Tarix sahələrinə cari tarixi təyin et
    const now = new Date();
    document.getElementById('transaction-date').value = now.toISOString().slice(0, 16);
    
    // İlkin tarix aralığını təyin et (cari ayın 1-ci günündən bu günə qədər)
    const firstDay = new Date(now.getFullYear(), now.getMonth(), 1).toISOString().split('T')[0];
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('export-start-date').value = firstDay;
    document.getElementById('export-end-date').value = today;
    
    // İlkin məlumatları yüklə
    updateDashboard();
    renderTransactionsTable();
    renderCategoriesList();
    updateCategorySelect();
    
    // Tab dəyişiklikləri
    document.querySelectorAll('.tab').forEach(tab => {
        tab.addEventListener('click', function() {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            
            this.classList.add('active');
            const tabId = this.getAttribute('data-tab');
            document.getElementById(tabId).classList.add('active');
            
            if (tabId === 'reservations') {
                renderTimeline();
            } else if (tabId === 'personal') {
                updateCurrentMonthDisplay();
                renderPersonalTimeline();
                renderSalaryTable();
                populateEmployeeSelect();
            }
        });
    });
    
    // Əməliyyat formu
    document.getElementById('transaction-form').addEventListener('submit', function(e) {
        e.preventDefault();
        addTransaction();
    });
    
    // Kateqoriya formu
    document.getElementById('category-form').addEventListener('submit', function(e) {
        e.preventDefault();
        addCategory();
    });
    
    // Gəlir/xərc növü dəyişəndə kateqoriyaları yenilə
    document.getElementById('transaction-type').addEventListener('change', updateCategorySelect);
    
    // Excel export düyməsi
    document.getElementById('export-excel-btn').addEventListener('click', exportToExcel);
    
    // Tarix aralığı dəyişəndə dashboard-u yenilə
    document.getElementById('export-start-date').addEventListener('change', updateDashboard);
    document.getElementById('export-end-date').addEventListener('change', updateDashboard);
    
    // Modal bağlama düymələri
    document.getElementById('close-reservation-income-modal').addEventListener('click', closeReservationIncomeModal);
    document.getElementById('cancel-reservation-income').addEventListener('click', closeReservationIncomeModal);
    
    // Initialize reservation events
    initReservationEvents();
    
    // Initialize personal management events
    initPersonalManagementEvents();
});

// ======================== CORE FUNCTIONS ========================

function generateReservationId() {
    return 'RES-' + Date.now().toString().slice(-6) + '-' + Math.floor(100 + Math.random() * 900);
}

function saveReservations() {
    localStorage.setItem('hotelReservations', JSON.stringify(reservations));
}

function getRoomType(roomNumber) {
    const room = rooms.find(r => r.number === roomNumber);
    return room ? room.type : 'standart';
}

function getStatusText(status) {
    const statusObj = statusDefinitions.find(s => s.id === status);
    return statusObj ? statusObj.name : 'Naməlum status';
}

function getStatusColor(status) {
    const statusObj = statusDefinitions.find(s => s.id === status);
    return statusObj ? statusObj.color : '#CCCCCC';
}

function calculateNights(checkInDate, checkOutDate) {
    const oneDay = 24 * 60 * 60 * 1000;
    const firstDate = new Date(checkInDate);
    const secondDate = new Date(checkOutDate);
    return Math.round(Math.abs((firstDate - secondDate) / oneDay));
}

function calculateTotalAmount(nights, rate) {
    return nights * rate;
}

function determineReservationStatus(reservation) {
    const { totalAmount, paidAmount, checkedIn, checkedOut, noShow, confirmed } = reservation;
    
    if (noShow) return 8;
    if (checkedOut) return paidAmount >= totalAmount ? (paidAmount > totalAmount ? 12 : 9) : (paidAmount > 0 ? 11 : 10);
    if (checkedIn) return paidAmount >= totalAmount ? 5 : (paidAmount > 0 ? 6 : 7);
    if (confirmed) return 4;
    return paidAmount >= totalAmount ? 3 : (paidAmount > 0 ? 2 : 1);
}

function getRoomTypeName(type) {
    const types = {
        'standart': 'Standart Otaq',
        'deluxe': 'Deluxe Otaq',
        'suit': 'Suit Otaq'
    };
    return types[type] || type;
}

function formatDate(dateString) {
    if (!dateString) return ''; // Əgər tarix yoxdursa, boş string qaytar
    
    try {
        const date = new Date(dateString);
        if (isNaN(date.getTime())) return dateString; // Əgər tarix etibarlı deyilsə, orijinal stringi qaytar
        
        return date.toLocaleDateString('az-AZ', {
            year: 'numeric',
            month: '2-digit',
            day: '2-digit',
            hour: '2-digit',
            minute: '2-digit'
        });
    } catch (e) {
        console.error('Tarix formatlama xətası:', e);
        return dateString; // Xəta halında orijinal stringi qaytar
    }
}

function getPaymentMethodName(method) {
    switch(method) {
        case 'cash': return 'Nağd';
        case 'card': return 'Kart';
        case 'transfer': return 'Kartdan-karta';
        default: return method;
    }
}

function showAlert(type, message) {
    const alertContainer = document.getElementById('alert-container');
    const alert = document.createElement('div');
    alert.className = `alert alert-${type}`;
    alert.innerHTML = `
        ${message}
        <span class="close-alert">&times;</span>
    `;
    
    alertContainer.appendChild(alert);
    
    // Görün et
    setTimeout(() => alert.classList.add('show'), 10);
    
    // Bağlama funksiyası
    alert.querySelector('.close-alert').addEventListener('click', () => {
        alert.classList.remove('show');
        setTimeout(() => alert.remove(), 300);
    });
    
    // 5 saniyədən sonra avtomatik bağlansın
    setTimeout(() => {
        alert.classList.remove('show');
        setTimeout(() => alert.remove(), 300);
    }, 5000);
}

// ======================== FINANCIAL MANAGEMENT ========================

function addTransaction() {
    const type = document.getElementById('transaction-type').value;
    const category = document.getElementById('transaction-category').value;
    const amount = parseFloat(document.getElementById('transaction-amount').value);
    const description = document.getElementById('transaction-description').value;
    const date = document.getElementById('transaction-date').value;
    const paymentMethod = document.querySelector('input[name="payment-method"]:checked').value;
    
    const transaction = {
        id: Date.now(),
        type,
        category,
        amount: parseFloat(amount) || 0,
        description,
        date,
        paymentMethod
    };
    
    transactions.push(transaction);
    saveTransactions();
    
    // Formu təmizlə
    document.getElementById('transaction-form').reset();
    document.getElementById('transaction-date').value = new Date().toISOString().slice(0, 16);
    
    // Yenilə
    updateDashboard();
    renderTransactionsTable();
    
    showAlert('success', 'Əməliyyat uğurla əlavə edildi');
}

function addCategory() {
    const type = document.getElementById('category-type').value;
    const name = document.getElementById('category-name').value;
    
    const category = {
        id: Date.now(),
        type,
        name
    };
    
    categories.push(category);
    saveCategories();
    
    // Formu təmizlə
    document.getElementById('category-form').reset();
    
    // Yenilə
    renderCategoriesList();
    updateCategorySelect();
    
    showAlert('success', 'Kateqoriya uğurla əlavə edildi');
}

function saveCategories() {
    localStorage.setItem('hotelCategories', JSON.stringify(categories));
}

function saveTransactions() {
    localStorage.setItem('hotelTransactions', JSON.stringify(transactions, (k, v) => {
  return typeof v === 'number' ? v.toString() : v;
  localStorage.setItem('hotelTransactions', JSON.stringify(transactions));
}));
}

function saveReservationIncomes() {
    localStorage.setItem('hotelReservationIncomes', JSON.stringify(reservationIncomes));
}

function deleteCategory(id) {
    if (confirm('Bu kateqoriyanı silmək istədiyinizə əminsiniz?')) {
        categories = categories.filter(cat => cat.id !== id);
        saveCategories();
        
        // Yenilə
        renderCategoriesList();
        updateCategorySelect();
        
        showAlert('success', 'Kateqoriya uğurla silindi');
    }
}

function deleteTransaction(id) {
    if (confirm('Bu əməliyyatı silmək istədiyinizə əminsiniz?')) {
        transactions = transactions.filter(trans => trans.id !== id);
        saveTransactions();
        
        // Yenilə
        updateDashboard();
        renderTransactionsTable();
        
        showAlert('success', 'Əməliyyat uğurla silindi');
    }
}

function updateDashboard() {
    const startDate = document.getElementById('export-start-date').value;
    const endDate = document.getElementById('export-end-date').value;
    
    if (!startDate || !endDate) {
        showAlert('danger', 'Zəhmət olmasa tarix aralığını düzgün seçin');
        return;
    }
    
    // Filtrə düşən əməliyyatlar
    const filteredTransactions = transactions.filter(trans => {
        const transDate = trans.date.split('T')[0];
        return transDate >= startDate && transDate <= endDate;
    });
    
    // Filtrə düşən rezervasiya gəlirləri
    const filteredReservations = reservationIncomes.filter(income => {
        const incomeDate = income.date.split('T')[0];
        return incomeDate >= startDate && incomeDate <= endDate;
    });
    
    // Ümumi gəlir - default 0 təyin edirik
    const totalIncome = filteredTransactions
        .filter(trans => trans.type === 'income')
        .reduce((sum, trans) => sum + (parseFloat(trans.amount) || 0), 0);
    
    // Rezervasiya gəlirlərini əlavə et
    const totalReservationIncome = filteredReservations
        .reduce((sum, income) => sum + (parseFloat(income.amount) || 0), 0);
    
    document.getElementById('total-income').textContent = (totalIncome + totalReservationIncome).toFixed(2) + ' ₼';
    
    // Ümumi xərc - default 0 təyin edirik
    const totalExpense = filteredTransactions
        .filter(trans => trans.type === 'expense')
        .reduce((sum, trans) => sum + (parseFloat(trans.amount) || 0), 0);
    
    document.getElementById('total-expense').textContent = totalExpense.toFixed(2) + ' ₼';
    
    // Xalis mənfəət
    const netProfit = (totalIncome + totalReservationIncome) - totalExpense;
    document.getElementById('net-profit').textContent = netProfit.toFixed(2) + ' ₼';
    document.getElementById('net-profit').className = netProfit >= 0 ? 'card-value income' : 'card-value expense';
    
    // Tarix aralığını göstər
    const startDateObj = new Date(startDate);
    const endDateObj = new Date(endDate);
    
    const periodText = formatDateRange(startDateObj, endDateObj);
    document.getElementById('income-period').textContent = periodText;
    document.getElementById('expense-period').textContent = periodText;
    document.getElementById('profit-period').textContent = periodText;
    
    // Son əməliyyatlar
    renderRecentTransactions();
}
function formatDateRange(startDate, endDate) {
    if (startDate.toDateString() === endDate.toDateString()) {
        return startDate.toLocaleDateString('az-AZ');
    }
    
    return `${startDate.toLocaleDateString('az-AZ')} - ${endDate.toLocaleDateString('az-AZ')}`;
}

function renderRecentTransactions() {
    const container = document.getElementById('recent-transactions');
    container.innerHTML = '';
    
    const startDate = document.getElementById('export-start-date').value;
    const endDate = document.getElementById('export-end-date').value;
    
    const recentTransactions = [...transactions]
        .filter(trans => {
            if (!trans.date) return false; // Əgər tarix yoxdursa, filtirlə
            const transDate = trans.date.split('T')[0];
            return transDate >= startDate && transDate <= endDate;
        })
        .sort((a, b) => new Date(b.date) - new Date(a.date))
        .slice(0, 10);
    
    if (recentTransactions.length === 0) {
        container.innerHTML = '<p>Hələ heç bir əməliyyat yoxdur</p>';
        return;
    }
    
    // İşçi xərclərini ayrıca qruplaşdırmaq üçün
    const employeeExpenses = recentTransactions.filter(t => 
        t.type === 'expense' && t.category === 'Əmək haqqı'
    );
    
    const otherTransactions = recentTransactions.filter(t => 
        !(t.type === 'expense' && t.category === 'Əmək haqqı')
    );
    
    if (employeeExpenses.length > 0) {
        const header = document.createElement('h4');
        header.textContent = 'İşçi xərcləri';
        header.style.marginTop = '20px';
        header.style.color = 'var(--c-green-500)';
        container.appendChild(header);
        
        employeeExpenses.forEach(trans => {
            const transEl = document.createElement('div');
            transEl.className = 'transaction';
            
            // Ədədə çevirmə əlavə edin
            const amount = parseFloat(trans.amount) || 0;
            
            transEl.innerHTML = `
                <div>
                    <span class="transaction-type transaction-expense">
                        Xərc (Əmək haqqı)
                    </span>
                    <span>${trans.description || ''}</span>
                    <div>${formatDate(trans.date)}</div>
                </div>
                <div>
                    <strong>${amount.toFixed(2)} ₼</strong>
                    <div>${getPaymentMethodName(trans.paymentMethod)}</div>
                </div>
            `;
            
            container.appendChild(transEl);
        });
    }
    
    if (otherTransactions.length > 0) {
        const header = document.createElement('h4');
        header.textContent = 'Digər əməliyyatlar';
        header.style.marginTop = '20px';
        header.style.color = 'var(--c-green-500)';
        container.appendChild(header);
        
        otherTransactions.forEach(trans => {
            const transEl = document.createElement('div');
            transEl.className = 'transaction';
            
            // Ədədə çevirmə əlavə edin
            const amount = parseFloat(trans.amount) || 0;
            
            transEl.innerHTML = `
                <div>
                    <span class="transaction-type ${trans.type === 'income' ? 'transaction-income' : 'transaction-expense'}">
                        ${trans.type === 'income' ? 'Gəlir' : 'Xərc'}
                    </span>
                    <span>${trans.category || ''}</span>
                    <div>${formatDate(trans.date)}</div>
                </div>
                <div>
                    <strong>${amount.toFixed(2)} ₼</strong>
                    <div>${getPaymentMethodName(trans.paymentMethod)}</div>
                </div>
            `;
            
            container.appendChild(transEl);
        });
    }
    
    // Rezervasiya gəlirləri üçün düymə əlavə et
    const showReservationButton = document.createElement('button');
    showReservationButton.className = 'btn btn-outline';
    showReservationButton.textContent = 'Rezervasiya gəlirlərini göstər';
    showReservationButton.addEventListener('click', showReservationIncomes);
    container.appendChild(showReservationButton);
}

function renderTransactionsTable() {
    const tbody = document.getElementById('transactions-table').querySelector('tbody');
    tbody.innerHTML = '';
    
    transactions.sort((a, b) => new Date(b.date) - new Date(a.date));
    
    transactions.forEach(trans => {
        const row = document.createElement('tr');
        
        // Ədədə çevirmə əlavə edin
        const amount = parseFloat(trans.amount) || 0;
        
        row.innerHTML = `
            <td>${formatDate(trans.date)}</td>
            <td>${trans.type === 'income' ? 'Gəlir' : 'Xərc'}</td>
            <td>${trans.category}</td>
            <td>${amount.toFixed(2)} ₼</td>
            <td>${getPaymentMethodName(trans.paymentMethod)}</td>
            <td>${trans.description || '-'}</td>
            <td>
                <button class="btn btn-outline btn-sm" onclick="deleteTransaction(${trans.id})">Sil</button>
            </td>
        `;
        
        tbody.appendChild(row);
    });
}
function renderCategoriesList() {
    const container = document.getElementById('categories-list');
    container.innerHTML = '';
    
    if (categories.length === 0) {
        container.innerHTML = '<p>Hələ heç bir kateqoriya yoxdur</p>';
        return;
    }
    
    categories.forEach(cat => {
        const item = document.createElement('div');
        item.className = 'category-item';
        
        item.innerHTML = `
            <span>${cat.name} <span class="category-badge">${cat.type === 'income' ? 'Gəlir' : 'Xərc'}</span></span>
            <button class="delete-btn" onclick="deleteCategory(${cat.id})">Sil</button>
        `;
        
        container.appendChild(item);
    });
}

function updateCategorySelect() {
    const type = document.getElementById('transaction-type').value;
    const select = document.getElementById('transaction-category');
    
    select.innerHTML = '<option value="">Seçin</option>';
    
    if (type) {
        const filteredCategories = categories.filter(cat => cat.type === type);
        filteredCategories.forEach(cat => {
            const option = document.createElement('option');
            option.value = cat.name;
            option.textContent = cat.name;
            select.appendChild(option);
        });
    }
}

function showReservationIncomes() {
    const modal = document.getElementById('reservationIncomeModal');
    const container = document.getElementById('reservation-income-details');
    
    container.innerHTML = '';
    
    const startDate = document.getElementById('export-start-date').value;
    const endDate = document.getElementById('export-end-date').value;
    
    const filteredIncomes = reservationIncomes.filter(income => {
        const incomeDate = income.date.split('T')[0];
        return incomeDate >= startDate && incomeDate <= endDate;
    });
    
    if (filteredIncomes.length === 0) {
        container.innerHTML = '<p>Seçilən tarix aralığında heç bir rezervasiya gəliri yoxdur</p>';
    } else {
        filteredIncomes.forEach(income => {
            const item = document.createElement('div');
            item.className = 'transaction';
            
            item.innerHTML = `
                <div>
                    <span class="transaction-type transaction-income">Gəlir</span>
                    <span>Otaq rezervasiyası</span>
                    <div>Otaq: ${income.roomNumber}, Qonaq: ${income.guestName}</div>
                </div>
                <div>
                    <strong>${income.amount.toFixed(2)} ₼</strong>
                    <div>${formatDate(income.date)}</div>
                </div>
            `;
            
            container.appendChild(item);
        });
    }
    
    modal.style.display = 'flex';
}

function closeReservationIncomeModal() {
    document.getElementById('reservationIncomeModal').style.display = 'none';
}

function exportToExcel() {
    const startDate = document.getElementById('export-start-date').value;
    const endDate = document.getElementById('export-end-date').value;
    
    if (!startDate || !endDate) {
        showAlert('danger', 'Zəhmət olmasa tarix aralığını düzgün seçin');
        return;
    }
    
    // Filtrə düşən əməliyyatlar
    const filteredTransactions = transactions.filter(trans => {
        const transDate = trans.date.split('T')[0];
        return transDate >= startDate && transDate <= endDate;
    });
    
    // Filtrə düşən rezervasiya gəlirləri
    const filteredReservations = reservationIncomes.filter(income => {
        const incomeDate = income.date.split('T')[0];
        return incomeDate >= startDate && incomeDate <= endDate;
    });

    // Find corresponding reservations for the incomes
    const reservationDetails = filteredReservations.map(income => {
        const reservation = reservations.find(r => r.id === income.reservationId);
        return {
            ...income,
            checkInDate: reservation ? reservation.checkInDate : '',
            checkOutDate: reservation ? reservation.checkOutDate : '',
            nights: reservation ? calculateNights(reservation.checkInDate, reservation.checkOutDate) : 0,
            nightlyRate: reservation ? reservation.nightlyRate : 0,
            company: reservation ? reservation.company : '',
            totalAmount: reservation ? reservation.totalAmount : 0
        };
    });

    // Gəlir və xərcləri ayır
    const incomeData = filteredTransactions
        .filter(trans => trans.type === 'income')
        .map(trans => ({
            'Tarix': formatDate(trans.date),
            'Növ': 'Gəlir',
            'Kateqoriya': trans.category,
            'Məbləğ (₼)': trans.amount,
            'Ödəniş üsulu': getPaymentMethodName(trans.paymentMethod),
            'Təsvir': trans.description || '-'
        }));
    
    // İşçi xərclərini ayrıca qeyd et
    const employeeExpenseData = filteredTransactions
        .filter(trans => trans.type === 'expense' && trans.category === 'Əmək haqqı')
        .map(trans => ({
            'Tarix': formatDate(trans.date),
            'Növ': 'Xərc (Əmək haqqı)',
            'İşçi': trans.description.split(' - ')[0],
            'Ödəniş növü': trans.description.split(' - ')[1],
            'Məbləğ (₼)': trans.amount,
            'Ödəniş üsulu': getPaymentMethodName(trans.paymentMethod),
            'Qeyd': '-'
        }));
    
    // Digər xərclər
    const otherExpenseData = filteredTransactions
        .filter(trans => trans.type === 'expense' && trans.category !== 'Əmək haqqı')
        .map(trans => ({
            'Tarix': formatDate(trans.date),
            'Növ': 'Xərc',
            'Kateqoriya': trans.category,
            'Məbləğ (₼)': trans.amount,
            'Ödəniş üsulu': getPaymentMethodName(trans.paymentMethod),
            'Təsvir': trans.description || '-'
        }));
    
    // Rezervasiya gəlirləri with additional details
    const reservationData = reservationDetails.map(item => ({
        'Tarix': formatDate(item.date),
        'Növ': 'Gəlir',
        'Kateqoriya': 'Otaq rezervasiyası',
        'Məbləğ (₼)': item.amount,
        'Ödəniş üsulu': getPaymentMethodName(item.paymentMethod),
        'Təsvir': item.description || '-',
        'Otaq No': item.roomNumber,
        'Qonaq': item.guestName,
        'Giriş Tarixi': formatDate(item.checkInDate),
        'Çıxış Tarixi': formatDate(item.checkOutDate),
        'Gecə Sayı': item.nights,
        'Gecəlik Qiymət': item.nightlyRate,
        'Ümumi Məbləğ': item.totalAmount,
        'Şirkət': item.company || ''
    }));
    
    // Excel iş kitabı yarat
    const workbook = XLSX.utils.book_new();
    
    // Gəlir vərəqi (əgər gəlir və ya rezervasiya varsa)
    const allIncomeData = [...incomeData, ...reservationData];
    if (allIncomeData.length > 0) {
        const incomeSheet = XLSX.utils.json_to_sheet(allIncomeData);
        XLSX.utils.book_append_sheet(workbook, incomeSheet, 'Gəlirlər');
    }
    
    // İşçi xərcləri vərəqi
    if (employeeExpenseData.length > 0) {
        const employeeExpenseSheet = XLSX.utils.json_to_sheet(employeeExpenseData);
        XLSX.utils.book_append_sheet(workbook, employeeExpenseSheet, 'Əmək haqqı xərcləri');
    }
    
    // Digər xərclər vərəqi
    if (otherExpenseData.length > 0) {
        const expenseSheet = XLSX.utils.json_to_sheet(otherExpenseData);
        XLSX.utils.book_append_sheet(workbook, expenseSheet, 'Digər xərclər');
    }
    
    // Excel faylını yüklə
    const fileName = `Hotel_Maliyye_${startDate}_${endDate}.xlsx`;
    XLSX.writeFile(workbook, fileName);
    
    showAlert('success', 'Excel faylı uğurla yükləndi');
}
// ======================== RESERVATION MANAGEMENT ========================

function createReservationElement(reservation, status, day) {
    const reservationEl = document.createElement('div');
    reservationEl.className = `reservation status-${status} ${reservation.isBooking ? 'booking' : ''}`;
    reservationEl.draggable = true;
    reservationEl.dataset.reservationId = reservation.id;
    
    
    const daysLeft = calculateNights(day.toISOString().split('T')[0], reservation.checkOutDate);
    const progress = ((calculateNights(reservation.checkInDate, day.toISOString().split('T')[0])) / 
                 calculateNights(reservation.checkInDate, reservation.checkOutDate)) * 100;

    const paidAmount = reservation.paymentMethods.reduce((sum, pm) => sum + pm.amount, 0);
    const balance = reservation.totalAmount - paidAmount;
    
    reservationEl.innerHTML = `
        <div class="reservation-info">
            <strong>${reservation.guestName}</strong>
            <span>${reservation.roomNumber}</span>
        </div>
        <div class="reservation-company">${reservation.company || ''}</div>
        <div class="reservation-timeline">
            <div class="reservation-progress" style="width: ${progress}%"></div>
        </div>
        <div class="reservation-hover-info">
            <p><strong>Giriş:</strong> ${formatDate(reservation.checkInDate)}</p>
            <p><strong>Çıxış:</strong> ${formatDate(reservation.checkOutDate)}</p>
            <p><strong>Qalıq gün:</strong> ${daysLeft}</p>
            <p><strong>Ümumi məbləğ:</strong> ${reservation.totalAmount.toFixed(2)} ₼</p>
            <p><strong>Qalıq:</strong> ${balance.toFixed(2)} ₼</p>
            <p><strong>Status:</strong> ${getStatusText(status)}</p>
        </div>
    `;
    reservationEl.addEventListener('dragstart', handleDragStart);
    
    
    return reservationEl;
}

let draggedReservation = null;

function handleDragStart(e) {
    draggedReservation = this;
    e.dataTransfer.effectAllowed = 'move';
    e.dataTransfer.setData('text/html', this.innerHTML);
    this.classList.add('dragging');
}

function handleDragOver(e) {
    if (e.preventDefault) e.preventDefault();
    e.dataTransfer.dropEffect = 'move';
    return false;
}

function handleDragEnter(e) {
    this.classList.add('over');
}

function handleDragLeave(e) {
    this.classList.remove('over');
}

function handleDrop(e) {
    if (e.stopPropagation) e.stopPropagation();
    
    if (draggedReservation) {
        const targetCell = this.closest('.room-cell');
        if (targetCell) {
            const roomNumber = targetCell.dataset.room;
            const date = targetCell.dataset.date;
            
            // Rezervasiyanı yenilə
            const reservationId = draggedReservation.dataset.reservationId;
            const reservation = reservations.find(r => r.id === reservationId);
            
            if (reservation) {
                // Otaq nömrəsini dəyiş
                if (roomNumber !== reservation.roomNumber) {
                    reservation.roomNumber = roomNumber;
                    reservation.roomType = getRoomType(roomNumber);
                }
                
                // Tarixləri yenilə
                const oldCheckInDate = reservation.checkInDate;
                const nights = calculateNights(reservation.checkInDate, reservation.checkOutDate);
                reservation.checkInDate = date;
                reservation.checkOutDate = new Date(new Date(date).getTime() + nights * 24 * 60 * 60 * 1000).toISOString().split('T')[0];
                
                saveReservations();
                renderTimeline();
                
                showAlert('success', 'Rezervasiya uğurla yeniləndi');
            }
        }
    }
    
    return false;
}

function handleDragEnd(e) {
    if (draggedReservation) {
        draggedReservation.classList.remove('dragging');
        draggedReservation = null;
    }
}

// Timeline-dəki hüceyrələrə drop event-lərini əlavə edirik
function addDropEventsToCells() {
    document.querySelectorAll('.room-cell').forEach(cell => {
        cell.addEventListener('dragover', handleDragOver);
        cell.addEventListener('drop', handleDrop);
        cell.addEventListener('dragenter', handleDragEnter);
        cell.addEventListener('dragleave', handleDragLeave);
    });
}

// renderTimeline funksiyasının sonunda addDropEventsToCells() çağırırıq

function updatePaidAmount() {
    let totalPaid = 0;
    document.querySelectorAll('.payment-amount').forEach(input => {
        const method = input.dataset.method;
        const checkbox = document.querySelector(`input[name="payment-method"][value="${method}"]`);
        if (checkbox && checkbox.checked && input.value) {
            totalPaid += parseFloat(input.value) || 0;
        }
    });
    
    document.getElementById('paid-amount').value = totalPaid;
    document.getElementById('detail-paid-amount').textContent = totalPaid;
    
    const totalAmount = parseFloat(document.getElementById('total-amount').value) || 0;
    const balance = totalAmount - totalPaid;
    document.getElementById('detail-balance').textContent = balance.toFixed(2);
    
    return totalPaid;
}

function updateReservationDetails(reservation) {
    const status = determineReservationStatus(reservation);
    
    document.getElementById('detail-status').textContent = getStatusText(status);
    document.getElementById('detail-total-amount').textContent = reservation.totalAmount.toFixed(2);
    document.getElementById('detail-paid-amount').textContent = reservation.paidAmount.toFixed(2);
    document.getElementById('detail-balance').textContent = (reservation.totalAmount - reservation.paidAmount).toFixed(2);
    document.getElementById('detail-checked-in').textContent = reservation.checkedIn ? 'Bəli' : 'Xeyr';
    document.getElementById('detail-checked-out').textContent = reservation.checkedOut ? 'Bəli' : 'Xeyr';
    document.getElementById('detail-no-show').textContent = reservation.noShow ? 'Bəli' : 'Xeyr';
    document.getElementById('detail-confirmed').textContent = reservation.confirmed ? 'Bəli' : 'Xeyr';
    
    const statusElement = document.getElementById('current-status');
    statusElement.textContent = `Cari Status: ${getStatusText(status)}`;
    statusElement.className = `current-status status-${status}`;
    statusElement.style.backgroundColor = getStatusColor(status);
    
    updateReservationSummary(reservation);
}

function updateReservationSummary(reservation) {
    document.getElementById('summary-checkin').textContent = formatDate(reservation.checkInDate);
    document.getElementById('summary-checkout').textContent = formatDate(reservation.checkOutDate);
    document.getElementById('summary-room').textContent = `${reservation.roomNumber} (${getRoomTypeName(reservation.roomType)})`;
    document.getElementById('summary-guest').textContent = reservation.guestName;
    document.getElementById('summary-total').textContent = `${reservation.totalAmount.toFixed(2)} ₼`;
    document.getElementById('summary-paid').textContent = `${reservation.paidAmount.toFixed(2)} ₼`;
    
    const paymentMethodsText = reservation.paymentMethods.length > 0 ? 
        reservation.paymentMethods.map(pm => `${getPaymentMethodName(pm.method)}: ${pm.amount} ₼`).join(', ') : 
        'Ödəniş olunmayıb';
    
    document.getElementById('summary-payment-methods').textContent = paymentMethodsText;
}

function calculateNightsAndTotal() {
    const checkInDate = document.getElementById('checkin-date').value;
    const checkOutDate = document.getElementById('checkout-date').value;
    const nightlyRate = parseFloat(document.getElementById('nightly-rate').value) || 0;
    
    if (checkInDate && checkOutDate) {
        const nights = calculateNights(checkInDate, checkOutDate);
        document.getElementById('nights-count').value = nights;
        const totalAmount = calculateTotalAmount(nights, nightlyRate);
        document.getElementById('total-amount').value = totalAmount;
        document.getElementById('detail-total-amount').textContent = totalAmount.toFixed(2);
        
        const paidAmount = parseFloat(document.getElementById('paid-amount').value) || 0;
        document.getElementById('detail-balance').textContent = (totalAmount - paidAmount).toFixed(2);
    }
}
function renderTimeline() {
    const timelineGrid = document.getElementById('timeline-grid');
    timelineGrid.innerHTML = '';
    
    const daysOfWeek = ['B.e', 'Ç.a', 'Ç.', 'C.a', 'C.', 'Ş.', 'B.'];
    const timelineEnd = new Date(currentWeekStart);
    timelineEnd.setDate(currentWeekStart.getDate() + 6);
    
    const monthNames = ["Yanvar", "Fevral", "Mart", "Aprel", "May", "İyun", 
                        "İyul", "Avqust", "Sentyabr", "Oktyabr", "Noyabr", "Dekabr"];
    
    document.getElementById('timeline-date-display').textContent = 
        `${monthNames[currentWeekStart.getMonth()]} ${currentWeekStart.getFullYear()}`;
    
    // Add headers
    const roomHeader = document.createElement('div');
    roomHeader.className = 'timeline-cell header';
    roomHeader.textContent = 'Otaq No';
    timelineGrid.appendChild(roomHeader);
    
    // Create day headers
    for (let i = 0; i < 7; i++) {
        const day = new Date(currentWeekStart);
        day.setDate(currentWeekStart.getDate() + i);
        
        const dayHeader = document.createElement('div');
        dayHeader.className = 'timeline-cell header';
        const dayName = daysOfWeek[day.getDay()];
        const dateNum = day.getDate();
        const isoDate = day.toISOString().split('T')[0];
        dayHeader.dataset.date = isoDate;
        dayHeader.textContent = `${dayName} ${dateNum}`;
        timelineGrid.appendChild(dayHeader);
    }
    // Filter values
const roomTypeFilter = document.getElementById('roomTypeFilter').value;
const statusFilter = document.getElementById('statusFilter').value;

// Add rooms and reservations
rooms.forEach(room => {
    if (roomTypeFilter && getRoomType(room.number) !== roomTypeFilter) return;
    
    // Room number cell
    const roomCell = document.createElement('div');
    roomCell.className = 'timeline-cell header';
    roomCell.textContent = room.number;
    timelineGrid.appendChild(roomCell);
    
    // Day cells for this room
    for (let i = 0; i < 7; i++) {
        const day = new Date(currentWeekStart);
        day.setDate(currentWeekStart.getDate() + i);
        const dayStr = day.toISOString().split('T')[0];
        
        const dayCell = document.createElement('div');
        dayCell.className = 'timeline-cell room-cell';
        dayCell.dataset.room = room.number;
        dayCell.dataset.date = dayStr;
        
        // Check if this day is part of any reservation
        const reservation = reservations.find(r => 
            r.roomNumber === room.number && 
            dayStr >= r.checkInDate && 
            dayStr < r.checkOutDate
        );
        
        if (reservation) {
            const status = determineReservationStatus(reservation);
            if (statusFilter && status.toString() !== statusFilter) {
                timelineGrid.appendChild(dayCell);
                continue;
            }
            
            // Create reservation element for all days of the reservation
            const reservationEl = createReservationElement(reservation, status, day);
            dayCell.appendChild(reservationEl);
            
            // Calculate how many days this reservation spans in the current week
            const startDate = new Date(reservation.checkInDate);
            const endDate = new Date(Math.min(new Date(reservation.checkOutDate), new Date(timelineEnd)));
            const dayCount = calculateNights(startDate, endDate);
            
            // Set grid column span to cover all days of the reservation in current week
            if (dayCount > 1) {
                reservationEl.style.gridColumn = `span ${dayCount}`;
            }
            
            reservationEl.addEventListener('click', (e) => {
                e.stopPropagation();
                openReservationModal(reservation);
            });
            
            // Apply status styling to all days
            if (reservation.checkedOut) {
                const paidAmount = reservation.paymentMethods.reduce((sum, pm) => sum + pm.amount, 0);
                const balance = reservation.totalAmount - paidAmount;
                
                let cellStatus;
                if (paidAmount > reservation.totalAmount) {
                    cellStatus = 12; // Artıq ödəniş
                } else if (paidAmount === reservation.totalAmount) {
                    cellStatus = 9;  // Tam ödəniş
                } else if (paidAmount > 0) {
                    cellStatus = 11; // Qismi ödəniş
                } else {
                    cellStatus = 10; // Ödəniş olunmayıb
                }
                
                dayCell.style.backgroundColor = getStatusColor(cellStatus) + '99';
                dayCell.style.borderLeft = `1px dashed ${getStatusColor(cellStatus)}`;
                dayCell.style.borderRight = `1px dashed ${getStatusColor(cellStatus)}`;
            }
        } else {
            dayCell.addEventListener('click', (e) => {
                e.stopPropagation();
                openReservationModal(room.number, dayStr);
            });
        }
        
        timelineGrid.appendChild(dayCell);
    }
});
// Add drop events to all cells
addDropEventsToCells();
}
function openReservationModal(reservationOrRoom, date) {
    const modal = document.getElementById('reservationModal');
    const form = document.getElementById('reservation-form');
    
    if (typeof reservationOrRoom === 'object') {
        // Editing existing reservation
        const reservation = reservationOrRoom;
        document.getElementById('modal-title').textContent = 'Rezervasiyanı redaktə et';
        document.getElementById('reservation-id').value = reservation.id;
        document.getElementById('guest-name').value = reservation.guestName;
        document.getElementById('guest-id').value = reservation.guestId;
        document.getElementById('guest-phone').value = reservation.phone;
        document.getElementById('guest-company').value = reservation.company;
        document.getElementById('room-type').value = reservation.roomType;
        document.getElementById('room-number').value = reservation.roomNumber;
        document.getElementById('checkin-date').value = reservation.checkInDate;
        document.getElementById('checkout-date').value = reservation.checkOutDate;
        document.getElementById('nightly-rate').value = reservation.nightlyRate;
        document.getElementById('nights-count').value = calculateNights(reservation.checkInDate, reservation.checkOutDate);
        document.getElementById('total-amount').value = reservation.totalAmount;
        document.getElementById('paid-amount').value = reservation.paidAmount;
        document.getElementById('is-booking').checked = reservation.isBooking;
        document.getElementById('reservation-notes').value = reservation.notes;
        
        // Clear payment methods
        document.querySelectorAll('input[name="payment-method"]').forEach(checkbox => {
            checkbox.checked = false;
        });
        document.querySelectorAll('.payment-amount').forEach(input => {
            input.value = '';
        });
        
        // Set payment methods
        reservation.paymentMethods.forEach(payment => {
            const checkbox = document.querySelector(`input[name="payment-method"][value="${payment.method}"]`);
            if (checkbox) {
                checkbox.checked = true;
                const amountInput = document.querySelector(`.payment-amount[data-method="${payment.method}"]`);
                if (amountInput) {
                    amountInput.value = payment.amount;
                }
            }
        });
        
        updateReservationDetails(reservation);
    } else {
        // Creating new reservation - burada tarixi düzgün təyin edirik
        document.getElementById('modal-title').textContent = 'Yeni Rezervasiya';
        form.reset();
        document.getElementById('reservation-id').value = generateReservationId();
        document.getElementById('room-number').value = reservationOrRoom;
        document.getElementById('room-type').value = getRoomType(reservationOrRoom);
        
        if (date) {
            // Tarixi düzgün formatda təyin edirik
            const formattedDate = new Date(date).toISOString().split('T')[0];
            document.getElementById('checkin-date').value = formattedDate;
            
            // Çıxış tarixini avtomatik +1 gün edirik
            const checkoutDate = new Date(date);
            checkoutDate.setDate(checkoutDate.getDate() + 1);
            document.getElementById('checkout-date').value = checkoutDate.toISOString().split('T')[0];
        }
        
        // Set default nightly rate based on room type
        const roomType = document.getElementById('room-type').value;
        document.getElementById('nightly-rate').value = roomType === 'deluxe' ? 120 : roomType === 'suit' ? 200 : 80;
        
        calculateNightsAndTotal();
        updatePaidAmount();
        
        // Clear reservation details
        document.getElementById('detail-status').textContent = '-';
        document.getElementById('detail-total-amount').textContent = '0';
        document.getElementById('detail-paid-amount').textContent = '0';
        document.getElementById('detail-balance').textContent = '0';
        document.getElementById('detail-checked-in').textContent = 'Xeyr';
        document.getElementById('detail-checked-out').textContent = 'Xeyr';
        document.getElementById('detail-no-show').textContent = 'Xeyr';
        document.getElementById('detail-confirmed').textContent = 'Xeyr';
        
        document.getElementById('current-status').textContent = '';
        document.getElementById('current-status').className = 'current-status';
    }
    
    modal.style.display = 'flex';
}

function openGroupReservationModal() {
    const modal = document.getElementById('groupReservationModal');
    const form = document.getElementById('group-reservation-form');
    
    form.reset();
    document.getElementById('group-room-type').value = '';
    
    // Set default dates to today + 1 day
    const today = new Date();
    const tomorrow = new Date(today);
    tomorrow.setDate(tomorrow.getDate() + 1);
    
    document.getElementById('group-checkin-date').value = today.toISOString().split('T')[0];
    document.getElementById('group-checkout-date').value = tomorrow.toISOString().split('T')[0];
    document.getElementById('group-nightly-rate').value = 80;
    
    // Load available rooms
    renderAvailableRoomsForGroup();
    
    modal.style.display = 'flex';
}

function renderAvailableRoomsForGroup() {
    const grid = document.getElementById('available-rooms-grid');
    grid.innerHTML = '';
    
    const checkInDate = document.getElementById('group-checkin-date').value;
    const checkOutDate = document.getElementById('group-checkout-date').value;
    const roomTypeFilter = document.getElementById('group-room-type').value;
    
    if (!checkInDate || !checkOutDate) return;
    
    // Find available rooms
    const availableRooms = rooms.filter(room => {
        // Filter by room type if selected
        if (roomTypeFilter && room.type !== roomTypeFilter) return false;
        
        // Check if room is available for the selected dates
        return !reservations.some(reservation => 
            reservation.roomNumber === room.number && 
            checkInDate < reservation.checkOutDate && 
            checkOutDate > reservation.checkInDate
        );
    });
    
    // Render available rooms
    availableRooms.forEach(room => {
        const roomCard = document.createElement('div');
        roomCard.className = 'group-room-card';
        roomCard.innerHTML = `
            <input type="checkbox" id="room-${room.number}" value="${room.number}">
            <label for="room-${room.number}">${room.number} (${getRoomTypeName(room.type)})</label>
        `;
        grid.appendChild(roomCard);
    });
}

function saveReservation() {
    const form = document.getElementById('reservation-form');
    const id = document.getElementById('reservation-id').value;
    
    // Collect payment methods
    const paymentMethods = [];
    document.querySelectorAll('input[name="payment-method"]:checked').forEach(checkbox => {
        const method = checkbox.value;
        const amountInput = document.querySelector(`.payment-amount[data-method="${method}"]`);
        const amount = parseFloat(amountInput.value) || 0;
        
        if (amount > 0) {
            paymentMethods.push({ method, amount });
        }
    });
    
    const totalPaid = paymentMethods.reduce((sum, pm) => sum + pm.amount, 0);
    
    const reservation = {
        id,
        guestName: document.getElementById('guest-name').value,
        guestId: document.getElementById('guest-id').value,
        phone: document.getElementById('guest-phone').value,
        company: document.getElementById('guest-company').value,
        roomNumber: document.getElementById('room-number').value,
        roomType: document.getElementById('room-type').value,
        checkInDate: document.getElementById('checkin-date').value,
        checkOutDate: document.getElementById('checkout-date').value,
        nightlyRate: parseFloat(document.getElementById('nightly-rate').value) || 0,
        totalAmount: parseFloat(document.getElementById('total-amount').value) || 0,
        paidAmount: totalPaid,
        paymentMethods,
        isBooking: document.getElementById('is-booking').checked,
        notes: document.getElementById('reservation-notes').value,
        checkedIn: false,
        checkedOut: false,
        noShow: false,
        confirmed: false
    };
    
    // Update status based on actions
    const statusElement = document.getElementById('current-status');
    if (statusElement.classList.contains('status-5') || statusElement.classList.contains('status-6') || statusElement.classList.contains('status-7')) {
        reservation.checkedIn = true;
    }
    if (statusElement.classList.contains('status-9') || statusElement.classList.contains('status-10') || statusElement.classList.contains('status-11') || statusElement.classList.contains('status-12')) {
        reservation.checkedOut = true;
    }
    if (statusElement.classList.contains('status-8')) {
        reservation.noShow = true;
    }
    if (statusElement.classList.contains('status-4')) {
        reservation.confirmed = true;
    }
    
    // Find existing reservation to check if we need to update income
    const existingIndex = reservations.findIndex(r => r.id === id);
    let existingReservation = null;
    if (existingIndex >= 0) {
        existingReservation = reservations[existingIndex];
    }
    
    // Update or add reservation
    if (existingIndex >= 0) {
        reservations[existingIndex] = reservation;
    } else {
        reservations.push(reservation);
    }
    
    saveReservations();
    renderTimeline();
    
    // Handle reservation income
    if (totalPaid > 0) {
        // Check if we need to update existing income or create new
        const existingIncomeIndex = reservationIncomes.findIndex(income => income.reservationId === id);
        
        if (existingIncomeIndex >= 0) {
            // Update existing income
            reservationIncomes[existingIncomeIndex] = {
                id: reservationIncomes[existingIncomeIndex].id,
                reservationId: id,
                guestName: reservation.guestName,
                roomNumber: reservation.roomNumber,
                amount: totalPaid,
                date: new Date().toISOString(),
                paymentMethods: paymentMethods,
                description: `Otaq rezervasiyası #${reservation.id}`
            };
        } else {
            // Add new income
            const income = {
                id: Date.now(),
                reservationId: id,
                guestName: reservation.guestName,
                roomNumber: reservation.roomNumber,
                amount: totalPaid,
                date: new Date().toISOString(),
                paymentMethods: paymentMethods,
                description: `Otaq rezervasiyası #${reservation.id}`
            };
            reservationIncomes.push(income);
        }
        
        saveReservationIncomes();
    } else if (existingReservation && existingReservation.paidAmount > 0) {
        // If payment was removed, delete the income record
        const incomeIndex = reservationIncomes.findIndex(income => income.reservationId === id);
        if (incomeIndex >= 0) {
            reservationIncomes.splice(incomeIndex, 1);
            saveReservationIncomes();
        }
    }
    
    showAlert('success', 'Rezervasiya uğurla yadda saxlanıldı');
    closeModal();
    updateDashboard(); // Update dashboard to reflect changes in income
}

function saveGroupReservation() {
    const form = document.getElementById('group-reservation-form');
    
    const checkInDate = document.getElementById('group-checkin-date').value;
    const checkOutDate = document.getElementById('group-checkout-date').value;
    const company = document.getElementById('group-company').value;
    const nightlyRate = parseFloat(document.getElementById('group-nightly-rate').value) || 0;
    
    if (!checkInDate || !checkOutDate) {
        showAlert('danger', 'Giriş və çıxış tarixlərini daxil edin');
        return;
    }
    
    const nights = calculateNights(checkInDate, checkOutDate);
    const totalAmount = calculateTotalAmount(nights, nightlyRate);
    
    // Get selected rooms
    const selectedRooms = [];
    document.querySelectorAll('.group-room-card input[type="checkbox"]:checked').forEach(checkbox => {
        selectedRooms.push(checkbox.value);
    });
    
    if (selectedRooms.length === 0) {
        showAlert('danger', 'Ən azı bir otaq seçin');
        return;
    }
    
    // Create reservations for each room
    selectedRooms.forEach(roomNumber => {
        const reservation = {
            id: generateReservationId(),
            guestName: company || 'Qrup rezervasiyası',
            guestId: '',
            phone: '',
            company,
            roomNumber,
            roomType: getRoomType(roomNumber),
            checkInDate,
            checkOutDate,
            nightlyRate,
            totalAmount,
            paidAmount: 0,
            paymentMethods: [],
            isBooking: false,
            notes: 'Qrup rezervasiyası',
            checkedIn: false,
            checkedOut: false,
            noShow: false,
            confirmed: false
        };
        
        reservations.push(reservation);
    });
    
    saveReservations();
    renderTimeline();
    
    showAlert('success', `${selectedRooms.length} otaq üçün qrup rezervasiyası uğurla yaradıldı`);
    closeGroupModal();
}

function deleteReservation() {
    const id = document.getElementById('reservation-id').value;
    const index = reservations.findIndex(r => r.id === id);
    
    if (index >= 0) {
        // Also delete any associated income
        const incomeIndex = reservationIncomes.findIndex(income => income.reservationId === id);
        if (incomeIndex >= 0) {
            reservationIncomes.splice(incomeIndex, 1);
            saveReservationIncomes();
        }
        
        reservations.splice(index, 1);
        saveReservations();
        renderTimeline();
        
        showAlert('success', 'Rezervasiya uğurla silindi');
        closeModal();
        updateDashboard(); // Update dashboard to reflect changes in income
    }
}

function closeModal() {
    document.getElementById('reservationModal').style.display = 'none';
}

function closeGroupModal() {
    document.getElementById('groupReservationModal').style.display = 'none';
}

function exportTimelineToExcel() {
    const workbook = XLSX.utils.book_new();
    
    // Prepare data
    const data = reservations.map(reservation => {
        const status = determineReservationStatus(reservation);
        
        return {
            'Otaq No': reservation.roomNumber,
            'Ad Soyad': reservation.guestName,
            'Giriş Tarixi': formatDate(reservation.checkInDate),
            'Çıxış Tarixi': formatDate(reservation.checkOutDate),
            'Gecə Sayı': calculateNights(reservation.checkInDate, reservation.checkOutDate),
            'Gecəlik Qiymət': reservation.nightlyRate,
            'Ümumi Məbləğ': reservation.totalAmount,
            'Ödənilib': reservation.paidAmount,
            'Qalıq': reservation.totalAmount - reservation.paidAmount,
            'Status': getStatusText(status),
            'Şirkət': reservation.company || '',
            'Qeydlər': reservation.notes || ''
        };
    });
    
    const worksheet = XLSX.utils.json_to_sheet(data);
    XLSX.utils.book_append_sheet(workbook, worksheet, 'Rezervasiyalar');
    
    // Generate and download the file
    XLSX.writeFile(workbook, 'Rezervasiyalar.xlsx');
}

function initReservationEvents() {
    // Timeline navigation
    document.getElementById('prev-week-timeline').addEventListener('click', function() {
        currentWeekStart.setDate(currentWeekStart.getDate() - 7);
        renderTimeline();
    });
    
    document.getElementById('next-week-timeline').addEventListener('click', function() {
        currentWeekStart.setDate(currentWeekStart.getDate() + 7);
        renderTimeline();
    });
    
    document.getElementById('today-btn-timeline').addEventListener('click', function() {
        currentWeekStart = new Date(currentDate);
        currentWeekStart.setDate(currentDate.getDate() - currentDate.getDay());
        renderTimeline();
    });
    
    // Reservation modal
    document.getElementById('add-reservation-btn').addEventListener('click', function() {
        openReservationModal(null, null);
    });
    
    document.getElementById('add-group-reservation-btn').addEventListener('click', function() {
        openGroupReservationModal();
    });
    
    document.getElementById('close-modal').addEventListener('click', closeModal);
    document.getElementById('close-group-modal').addEventListener('click', closeGroupModal);
    
    document.getElementById('cancel-reservation').addEventListener('click', closeModal);
    document.getElementById('cancel-group-reservation').addEventListener('click', closeGroupModal);
    
    // Reservation form
    document.getElementById('reservation-form').addEventListener('submit', function(e) {
        e.preventDefault();
        saveReservation();
    });
    
    document.getElementById('group-reservation-form').addEventListener('submit', function(e) {
        e.preventDefault();
        saveGroupReservation();
    });
    
    // Date calculations
    document.getElementById('checkin-date').addEventListener('change', calculateNightsAndTotal);
    document.getElementById('checkout-date').addEventListener('change', calculateNightsAndTotal);
    document.getElementById('nightly-rate').addEventListener('change', calculateNightsAndTotal);
    
    document.getElementById('group-checkin-date').addEventListener('change', renderAvailableRoomsForGroup);
    document.getElementById('group-checkout-date').addEventListener('change', renderAvailableRoomsForGroup);
    document.getElementById('group-room-type').addEventListener('change', renderAvailableRoomsForGroup);
    
    // Payment methods
    document.querySelectorAll('input[name="payment-method"]').forEach(checkbox => {
        checkbox.addEventListener('change', updatePaidAmount);
    });
    
    document.querySelectorAll('.payment-amount').forEach(input => {
        input.addEventListener('input', updatePaidAmount);
    });
    
    // Status actions
    document.getElementById('checkin-btn').addEventListener('click', function() {
        const totalAmount = parseFloat(document.getElementById('total-amount').value) || 0;
        const paidAmount = parseFloat(document.getElementById('paid-amount').value) || 0;
        
        const statusElement = document.getElementById('current-status');
        if (paidAmount >= totalAmount) {
            statusElement.className = 'current-status status-5';
            statusElement.textContent = 'Cari Status: Qonaq giriş edib tam ödəniş edib';
        } else if (paidAmount > 0) {
            statusElement.className = 'current-status status-6';
            statusElement.textContent = 'Cari Status: Qonaq giriş edib qismi ödəniş edib';
        } else {
            statusElement.className = 'current-status status-7';
            statusElement.textContent = 'Cari Status: Qonaq giriş edib ödəniş etməyib';
        }
    });
    
    document.getElementById('checkout-btn').addEventListener('click', function() {
        const totalAmount = parseFloat(document.getElementById('total-amount').value) || 0;
        const paidAmount = parseFloat(document.getElementById('paid-amount').value) || 0;
        
        const statusElement = document.getElementById('current-status');
        if (paidAmount > totalAmount) {
            statusElement.className = 'current-status status-12';
            statusElement.textContent = 'Cari Status: Qonaq giriş edib çıxış edib artıq ödəniş edib';
        } else if (paidAmount === totalAmount) {
            statusElement.className = 'current-status status-9';
            statusElement.textContent = 'Cari Status: Qonaq giriş edib çıxışda edib tam ödəniş edib';
        } else if (paidAmount > 0) {
            statusElement.className = 'current-status status-11';
            statusElement.textContent = 'Cari Status: Qonaq giriş edib çıxış edib qismi ödəniş edib';
        } else {
            statusElement.className = 'current-status status-10';
            statusElement.textContent = 'Cari Status: Qonaq giriş edib çıxış edib ödəniş etməyib';
        }
    });
    
    document.getElementById('no-show-btn').addEventListener('click', function() {
        const statusElement = document.getElementById('current-status');
        statusElement.className = 'current-status status-8';
        statusElement.textContent = 'Cari Status: Qonaq gəlmədi';
    });
    
    document.getElementById('confirm-btn').addEventListener('click', function() {
        const statusElement = document.getElementById('current-status');
        statusElement.className = 'current-status status-4';
        statusElement.textContent = 'Cari Status: Rezerv dəqiqləşdirilib';
    });
    
    document.getElementById('delete-reservation-btn').addEventListener('click', function() {
        if (confirm('Bu rezervasiyanı silmək istədiyinizə əminsiniz?')) {
            deleteReservation();
        }
    });
    
    // Export buttons
    document.getElementById('export-timeline').addEventListener('click', exportTimelineToExcel);
    
    // Filter changes
    document.getElementById('roomTypeFilter').addEventListener('change', renderTimeline);
    document.getElementById('statusFilter').addEventListener('change', renderTimeline);

    document.getElementById('generate-confirmation-btn').addEventListener('click', function() {
        const reservationId = document.getElementById('reservation-id').value;
        const reservation = reservations.find(r => r.id === reservationId);
        if (reservation) {
            generateConfirmation(reservation);
        } else {
            showAlert('danger', 'Rezervasiya tapılmadı');
        }
    });

    document.getElementById('generate-invoice-btn').addEventListener('click', function() {
        const reservationId = document.getElementById('reservation-id').value;
        const reservation = reservations.find(r => r.id === reservationId);
        if (reservation) {
            generateInvoice(reservation);
        } else {
            showAlert('danger', 'Rezervasiya tapılmadı');
        }
    });

    document.getElementById('generate-registration-btn').addEventListener('click', function() {
        const reservationId = document.getElementById('reservation-id').value;
        const reservation = reservations.find(r => r.id === reservationId);
        if (reservation) {
            generateRegistrationForm(reservation);
        } else {
            showAlert('danger', 'Rezervasiya tapılmadı');
        }
    });

    document.getElementById('generate-group-invoice-btn').addEventListener('click', function() {
        const checkInDate = document.getElementById('group-checkin-date').value;
        const checkOutDate = document.getElementById('group-checkout-date').value;
        const company = document.getElementById('group-company').value;
        
        const selectedRooms = [];
        document.querySelectorAll('.group-room-card input[type="checkbox"]:checked').forEach(checkbox => {
            selectedRooms.push(checkbox.value);
        });
        
        if (selectedRooms.length === 0) {
            showAlert('danger', 'Ən azı bir otaq seçin');
            return;
        }
        
        // Create mock reservations for the group
        const groupReservations = selectedRooms.map(roomNumber => ({
            id: generateReservationId(),
            guestName: company || 'Qrup rezervasiyası',
            company: company,
            roomNumber: roomNumber,
            roomType: getRoomType(roomNumber),
            checkInDate: checkInDate,
            checkOutDate: checkOutDate,
            nightlyRate: parseFloat(document.getElementById('group-nightly-rate').value) || 0,
            totalAmount: calculateTotalAmount(
                calculateNights(checkInDate, checkOutDate),
                parseFloat(document.getElementById('group-nightly-rate').value) || 0
            ),
            paidAmount: 0,
            paymentMethods: []
        }));
        
        generateGroupInvoice(groupReservations);
    });

}

// ======================== PERSONAL MANAGEMENT ========================

function updateCurrentMonthDisplay() {
    const monthNames = ["Yanvar", "Fevral", "Mart", "Aprel", "May", "İyun", 
                      "İyul", "Avqust", "Sentyabr", "Oktyabr", "Noyabr", "Dekabr"];
    document.getElementById('currentMonth').textContent = `${monthNames[currentMonth]} ${currentYear}`;
}

function getDaysInMonth(month, year) {
    return new Date(year, month + 1, 0).getDate();
}

// Personal timeline rendering function
function renderPersonalTimeline() {
    const timelineGrid = document.getElementById('personal-timeline-grid');
    timelineGrid.innerHTML = '';
    
    const daysOfWeek = ['B.e', 'Ç.a', 'Ç.', 'C.a', 'C.', 'Ş.', 'B.'];
    const timelineEnd = new Date(currentWeekStart);
    timelineEnd.setDate(currentWeekStart.getDate() + 6);
    
    const monthNames = ["Yanvar", "Fevral", "Mart", "Aprel", "May", "İyun", 
                       "İyul", "Avqust", "Sentyabr", "Oktyabr", "Noyabr", "Dekabr"];
    
    document.getElementById('currentMonth').textContent = 
        `${monthNames[currentWeekStart.getMonth()]} ${currentWeekStart.getFullYear()}`;
    
    // Add headers
    const employeeHeader = document.createElement('div');
    employeeHeader.className = 'timeline-cell header';
    employeeHeader.textContent = 'İşçi';
    timelineGrid.appendChild(employeeHeader);
    
    // Create day headers
    for (let i = 0; i < 7; i++) {
        const day = new Date(currentWeekStart);
        day.setDate(currentWeekStart.getDate() + i);
        
        const dayHeader = document.createElement('div');
        dayHeader.className = 'timeline-cell header';
        const dayName = daysOfWeek[day.getDay()];
        const dateNum = day.getDate();
        const isoDate = day.toISOString().split('T')[0];
        dayHeader.dataset.date = isoDate;
        dayHeader.textContent = `${dayName} ${dateNum}`;
        timelineGrid.appendChild(dayHeader);
    }
    
    // Add employees and their work days
    employees.filter(e => e.active).forEach(employee => {
        // Employee name cell
        const nameCell = document.createElement('div');
        nameCell.className = 'timeline-cell header';
        
        let salaryTypes = [];
        if (employee.monthlySalary > 0) salaryTypes.push('Aylıq');
        if (employee.dailySalary > 0) salaryTypes.push('Gündəlik');
        
        nameCell.textContent = `${employee.name} (${salaryTypes.join(' + ')})`;
        timelineGrid.appendChild(nameCell);
        
        // Day cells for this employee
        for (let i = 0; i < 7; i++) {
            const day = new Date(currentWeekStart);
            day.setDate(currentWeekStart.getDate() + i);
            const dayStr = day.toISOString().split('T')[0];
            
            const dayCell = document.createElement('div');
            dayCell.className = 'timeline-cell workday-cell';
            dayCell.dataset.employee = employee.id;
            dayCell.dataset.date = dayStr;
            
            // Check if this is a work day
            const workDayKey = `${employee.id}_${dayStr}`;
            const isWorkDay = workDays[workDayKey] || false;
            
            if (isWorkDay) {
                const workDayEl = document.createElement('div');
                workDayEl.className = 'workday';
                workDayEl.innerHTML = `
                    <div class="workday-info">
                        <span class="workday-amount">${employee.dailySalary.toFixed(2)} ₼</span>
                    </div>
                `;
                dayCell.appendChild(workDayEl);
            }
            
            dayCell.addEventListener('click', (e) => {
                e.stopPropagation();
                toggleWorkDay(employee.id, dayStr, !isWorkDay);
            });
            
            timelineGrid.appendChild(dayCell);
        }
    });
}

// Update the initPersonalManagementEvents function
function initPersonalManagementEvents() {
    // ... existing code ...
    
    // Update month navigation handlers
    document.getElementById('prev-week-personal').addEventListener('click', () => {
        currentWeekStart.setDate(currentWeekStart.getDate() - 7);
        renderPersonalTimeline();
    });
    
    document.getElementById('next-week-personal').addEventListener('click', () => {
        currentWeekStart.setDate(currentWeekStart.getDate() + 7);
        renderPersonalTimeline();
    });
    
    document.getElementById('today-btn-personal').addEventListener('click', () => {
        currentWeekStart = new Date(currentDate);
        currentWeekStart.setDate(currentDate.getDate() - currentDate.getDay());
        renderPersonalTimeline();
    });
    
    // ... rest of the existing code ...
}

function toggleWorkDay(employeeId, date, isWorkDay) {
    const key = `${employeeId}_${date}`;
    
    if (isWorkDay) {
        workDays[key] = true;
    } else {
        delete workDays[key];
    }
    
    saveWorkDays();
    renderPersonalTimeline(); // Yenilənmiş timeline render funksiyasını çağırırıq
    renderSalaryTable();
}


function saveWorkDays() {
    localStorage.setItem('workDays', JSON.stringify(workDays));
}

function renderSalaryTable() {
    const salaryTableBody = document.getElementById('salaryTableBody');
    salaryTableBody.innerHTML = '';
    
    if (employees.length === 0) {
        const row = document.createElement('tr');
        row.innerHTML = `<td colspan="8" class="text-center">Heç bir işçi yoxdur</td>`;
        salaryTableBody.appendChild(row);
        return;
    }
    
    employees.filter(e => e.active).forEach(employee => {
        // Calculate work days for current month
        const daysInMonth = getDaysInMonth(currentMonth, currentYear);
        let workDaysCount = 0;
        
        for (let day = 1; day <= daysInMonth; day++) {
            const dateStr = `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
            const workDayKey = `${employee.id}_${dateStr}`;
            if (workDays[workDayKey]) {
                workDaysCount++;
            }
        }
        
        // Get all payments for this employee in current month
        const monthPayments = salaryPayments.filter(payment => 
            payment.employeeId === employee.id && 
            new Date(payment.date).getMonth() === currentMonth &&
            new Date(payment.date).getFullYear() === currentYear
        );
        
        // Calculate different payment types
        const advances = monthPayments
            .filter(p => p.type === 'advance')
            .reduce((sum, p) => sum + p.amount, 0);
        
        const bonuses = monthPayments
            .filter(p => p.type === 'bonus')
            .reduce((sum, p) => sum + p.amount, 0);
        
        const salaryPaymentsForMonth = monthPayments
            .filter(p => p.type === 'salary')
            .reduce((sum, p) => sum + p.amount, 0);
        
        // Calculate total salary
        let totalSalary = 0;
        let salaryDescription = '';
        
        if (employee.monthlySalary > 0 && employee.dailySalary > 0) {
            // Hər iki maaş növü üçün
            const dailyEarnings = employee.dailySalary * workDaysCount;
            totalSalary = employee.monthlySalary + dailyEarnings;
            salaryDescription = `Aylıq: ${employee.monthlySalary.toFixed(2)} ₼ + Gündəlik: ${employee.dailySalary.toFixed(2)} ₼ × ${workDaysCount} gün = ${totalSalary.toFixed(2)} ₼`;
        } else if (employee.monthlySalary > 0) {
            // Sadəcə aylıq maaş üçün
            totalSalary = employee.monthlySalary;
            salaryDescription = `Aylıq: ${totalSalary.toFixed(2)} ₼`;
        } else if (employee.dailySalary > 0) {
            // Sadəcə gündəlik maaş üçün
            totalSalary = employee.dailySalary * workDaysCount;
            salaryDescription = `Gündəlik: ${employee.dailySalary.toFixed(2)} ₼ × ${workDaysCount} gün = ${totalSalary.toFixed(2)} ₼`;
        }
        
        // Calculate remaining salary (only deduct advances and salary payments, not bonuses)
        const remainingSalary = totalSalary - advances - salaryPaymentsForMonth;
        
        // Create table row
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>${employee.name}</td>
            <td>${employee.monthlySalary > 0 ? (employee.dailySalary > 0 ? 'Aylıq + Gündəlik' : 'Aylıq') : 'Gündəlik'}</td>
            <td class="text-right">${totalSalary.toFixed(2)} ₼</td>
            <td class="text-right editable" data-employee="${employee.id}" data-type="advance">${advances.toFixed(2)} ₼</td>
            <td class="text-right editable" data-employee="${employee.id}" data-type="bonus">${bonuses.toFixed(2)} ₼</td>
            <td class="text-right editable" data-employee="${employee.id}" data-type="salary">${salaryPaymentsForMonth.toFixed(2)} ₼</td>
            <td class="text-right">${remainingSalary.toFixed(2)} ₼</td>
            <td class="text-center">
                <button class="btn btn-sm btn-primary view-payments-btn" data-employee="${employee.id}">Bax</button>
            </td>
        `;
        
        salaryTableBody.appendChild(row);
    });
    
    // Add event listeners to editable cells
    document.querySelectorAll('.editable').forEach(cell => {
        cell.addEventListener('click', function() {
            const employeeId = this.getAttribute('data-employee');
            const paymentType = this.getAttribute('data-type');
            openAddPaymentModal(employeeId, paymentType);
        });
    });
    
    // Add event listeners to view payments buttons
    document.querySelectorAll('.view-payments-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const employeeId = this.getAttribute('data-employee');
            viewEmployeePayments(employeeId);
        });
    });
}

function openAddPaymentModal(employeeId, paymentType) {
    const employee = employees.find(e => e.id === employeeId);
    if (!employee) return;
    
    document.getElementById('salaryModal').style.display = 'flex';
    document.getElementById('salaryForm').reset();
    document.getElementById('salaryPaymentDate').valueAsDate = new Date();
    
    // Pre-fill the form
    document.getElementById('salaryEmployee').value = employeeId;
    document.getElementById('salaryPaymentType').value = paymentType;
    
    // Focus on amount field
    document.getElementById('salaryPaymentAmount').focus();
}

function viewEmployeePayments(employeeId) {
    const employee = employees.find(e => e.id === employeeId);
    if (!employee) return;
    
    const monthPayments = salaryPayments.filter(payment => 
        payment.employeeId === employeeId && 
        new Date(payment.date).getMonth() === currentMonth &&
        new Date(payment.date).getFullYear() === currentYear
    );
    
    if (monthPayments.length === 0) {
        showAlert('info', `${employee.name} üçün bu ayda heç bir ödəniş qeyd edilməyib`);
        return;
    }
    
    let message = `<strong>${employee.name} üçün bu ayın ödənişləri:</strong><br><br>`;
    
    monthPayments.forEach(payment => {
        const typeMap = {
            'salary': 'Maaş',
            'advance': 'Avans',
            'bonus': 'Premya'
        };
        
        message += `
            <div style="margin-bottom: 10px;">
                <strong>${typeMap[payment.type]}:</strong> ${payment.amount.toFixed(2)} ₼<br>
                <small>Tarix: ${formatDate(payment.date)}</small><br>
                <small>Qeyd: ${payment.note || 'Yoxdur'}</small>
                <button class="btn btn-sm btn-warning" onclick="editPayment('${payment.id}')" style="margin-left: 10px;">Redaktə</button>
            </div>
        `;
    });
    
    showAlert('info', message);
}

function editPayment(paymentId) {
    const payment = salaryPayments.find(p => p.id === paymentId);
    if (!payment) return;
    
    const employee = employees.find(e => e.id === payment.employeeId);
    
    document.getElementById('editPaymentId').value = payment.id;
    document.getElementById('editSalaryEmployee').value = employee ? employee.name : '';
    document.getElementById('editSalaryPaymentType').value = payment.type;
    document.getElementById('editSalaryPaymentAmount').value = payment.amount;
    document.getElementById('editSalaryPaymentDate').value = payment.date;
    document.getElementById('editSalaryPaymentNote').value = payment.note || '';
    
    document.getElementById('editSalaryModal').style.display = 'flex';
}

function populateEmployeeSelect() {
    const salaryEmployeeSelect = document.getElementById('salaryEmployee');
    salaryEmployeeSelect.innerHTML = '<option value="">Seçin</option>';
    
    employees.filter(e => e.active).forEach(employee => {
        let salaryTypes = [];
        if (employee.monthlySalary > 0) salaryTypes.push('Aylıq');
        if (employee.dailySalary > 0) salaryTypes.push('Gündəlik');
        
        const option = document.createElement('option');
        option.value = employee.id;
        option.textContent = `${employee.name} (${salaryTypes.join(' + ')})`;
        salaryEmployeeSelect.appendChild(option);
    });
}

function addEmployee() {
    const monthlySalary = document.getElementById('monthlySalaryCheck').checked ? parseFloat(document.getElementById('monthlySalaryAmount').value) || 0 : 0;
    const dailySalary = document.getElementById('dailySalaryCheck').checked ? parseFloat(document.getElementById('dailySalaryAmount').value) || 0 : 0;
    
    if (monthlySalary === 0 && dailySalary === 0) {
        showAlert('danger', 'Ən azı bir maaş növü və məbləği daxil edin');
        return;
    }
    
    const employee = {
        id: Date.now().toString(),
        name: document.getElementById('employeeName').value,
        position: document.getElementById('employeePosition').value,
        monthlySalary: monthlySalary,
        dailySalary: dailySalary,
        phone: document.getElementById('employeePhone').value,
        active: true
    };
    
    employees.push(employee);
    saveEmployees();
    
    document.getElementById('employeeModal').style.display = 'none';
    
    // Yeniləmələri əlavə et
    renderPersonalTimeline();
    renderSalaryTable();
    populateEmployeeSelect();
    
    showAlert('success', 'İşçi uğurla əlavə edildi');
}


function saveEmployees() {
    localStorage.setItem('employees', JSON.stringify(employees));
}

function addSalaryPayment() {
    const employeeId = document.getElementById('salaryEmployee').value;
    const paymentType = document.getElementById('salaryPaymentType').value;
    const amount = parseFloat(document.getElementById('salaryPaymentAmount').value);
    const date = document.getElementById('salaryPaymentDate').value;
    const note = document.getElementById('salaryPaymentNote').value;
    
    if (!employeeId || !paymentType || !amount || !date) {
        showAlert('danger', 'Zəhmət olmasa bütün məlumatları doldurun');
        return;
    }
    
    const employee = employees.find(e => e.id === employeeId);
    if (!employee) return;
    
    const payment = {
        id: Date.now().toString(),
        employeeId: employeeId,
        type: paymentType,
        amount: amount,
        date: date,
        note: note
    };
    
    salaryPayments.push(payment);
    saveSalaryPayments();
    
    // Store payment date for salary type
    if (paymentType === 'salary') {
        salaryPaymentDates[employeeId] = date;
        localStorage.setItem('salaryPaymentDates', JSON.stringify(salaryPaymentDates));
    }
    
    // Xərc olaraq əlavə et
    const transaction = {
        id: Date.now(),
        type: 'expense',
        category: 'Əmək haqqı',
        amount: amount,
        description: `${employee.name} - ${paymentType === 'salary' ? 'Maaş' : paymentType === 'advance' ? 'Avans' : 'Premya'}`,
        date: date,
        paymentMethod: 'cash' // və ya digər ödəniş üsulu
    };
    
    transactions.push(transaction);
    saveTransactions();
    
    document.getElementById('salaryModal').style.display = 'none';
    renderSalaryTable();
    updateDashboard(); // İdarə panelini yenilə
    
    showAlert('success', 'Ödəniş uğurla əlavə edildi və xərc olaraq qeyd edildi');
}

function updateSalaryPayment() {
    const paymentId = document.getElementById('editPaymentId').value;
    const paymentIndex = salaryPayments.findIndex(p => p.id === paymentId);
    
    if (paymentIndex === -1) return;
    
    const oldPayment = salaryPayments[paymentIndex];
    const employeeId = oldPayment.employeeId;
    const paymentType = document.getElementById('editSalaryPaymentType').value;
    const amount = parseFloat(document.getElementById('editSalaryPaymentAmount').value);
    const date = document.getElementById('editSalaryPaymentDate').value;
    const note = document.getElementById('editSalaryPaymentNote').value;
    
    const employee = employees.find(e => e.id === employeeId);
    
    // Köhnə xərci sil
    transactions = transactions.filter(t => 
        !(t.description.includes(`${employee.name} - ${oldPayment.type === 'salary' ? 'Maaş' : oldPayment.type === 'advance' ? 'Avans' : 'Premya'}`) && 
          t.amount === oldPayment.amount)
    );
    
    salaryPayments[paymentIndex] = {
        id: paymentId,
        employeeId: employeeId,
        type: paymentType,
        amount: amount,
        date: date,
        note: note
    };
    
    saveSalaryPayments();
    
    // Yeni xərc əlavə et
    const transaction = {
        id: Date.now(),
        type: 'expense',
        category: 'Əmək haqqı',
        amount: amount,
        description: `${employee.name} - ${paymentType === 'salary' ? 'Maaş' : paymentType === 'advance' ? 'Avans' : 'Premya'}`,
        date: date,
        paymentMethod: 'cash'
    };
    
    transactions.push(transaction);
    saveTransactions();
    
    // Update payment date for salary type if changed
    if (paymentType === 'salary') {
        salaryPaymentDates[employeeId] = date;
        localStorage.setItem('salaryPaymentDates', JSON.stringify(salaryPaymentDates));
    }
    
    document.getElementById('editSalaryModal').style.display = 'none';
    renderSalaryTable();
    updateDashboard(); // İdarə panelini yenilə
    
    showAlert('success', 'Ödəniş uğurla yeniləndi və xərc qeydi dəyişdirildi');
}
function saveSalaryPayments() {
    localStorage.setItem('salaryPayments', JSON.stringify(salaryPayments));
}

function exportPersonalToExcel() {
    try {
        // Create a workbook
        const workbook = XLSX.utils.book_new();
        
        // Add summary sheet
        const summaryData = [
            ['Maaş hesablamaları - Ümumi məlumat'],
            ['Ay', document.getElementById('currentMonth').textContent],
            ['İşçi sayı', employees.filter(e => e.active).length],
            ['Ümumi məbləğ', calculateTotalSalary()],
            ['Ümumi ödənişlər', calculateTotalPayments()]
        ];
        const summarySheet = XLSX.utils.aoa_to_sheet(summaryData);
        XLSX.utils.book_append_sheet(workbook, summarySheet, "Ümumi məlumat");
        
        // Add employees sheet
        const employeesData = [
            ['Ad Soyad', 'Vəzifə', 'Maaş növü', 'Aylıq maaş', 'Gündəlik maaş', 'Telefon', 'Status']
        ];
        
        employees.forEach(employee => {
            employeesData.push([
                employee.name,
                employee.position,
                employee.monthlySalary > 0 ? (employee.dailySalary > 0 ? 'Aylıq + Gündəlik' : 'Aylıq') : 'Gündəlik',
                employee.monthlySalary,
                employee.dailySalary,
                employee.phone,
                employee.active ? 'Aktiv' : 'Passiv'
            ]);
        });
        
        const employeesSheet = XLSX.utils.aoa_to_sheet(employeesData);
        XLSX.utils.book_append_sheet(workbook, employeesSheet, "İşçilər");
        
        // Add payments sheet
        const paymentsData = [
            ['Tarix', 'İşçi', 'Ödəniş növü', 'Məbləğ (₼)', 'Qeyd']
        ];
        
        salaryPayments.forEach(payment => {
            const employee = employees.find(e => e.id === payment.employeeId);
            paymentsData.push([
                formatDate(payment.date),
                employee ? employee.name : 'Naməlum',
                payment.type === 'salary' ? 'Maaş' : (payment.type === 'advance' ? 'Avans' : 'Premya'),
                payment.amount,
                payment.note || ''
            ]);
        });
        
        const paymentsSheet = XLSX.utils.aoa_to_sheet(paymentsData);
        XLSX.utils.book_append_sheet(workbook, paymentsSheet, "Maaş ödənişləri");
        
        // Generate and download the Excel file
        XLSX.writeFile(workbook, `Maaş_hesablamaları_${document.getElementById('currentMonth').textContent.replace(' ', '_')}.xlsx`);
        
        showAlert('success', 'Excel faylı uğurla yükləndi');
    } catch (e) {
        showAlert('danger', 'Excel faylı yüklənərkən xəta baş verdi: ' + e.message);
    }
}

function calculateTotalSalary() {
    let total = 0;
    const daysInMonth = getDaysInMonth(currentMonth, currentYear);
    
    employees.filter(e => e.active).forEach(employee => {
        // Calculate work days for current month
        let workDaysCount = 0;
        
        for (let day = 1; day <= daysInMonth; day++) {
            const dateStr = `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
            const workDayKey = `${employee.id}_${dateStr}`;
            if (workDays[workDayKey]) {
                workDaysCount++;
            }
        }
        
        if (employee.monthlySalary > 0) {
            // Monthly salary - deduct for missing days
            const missingDays = daysInMonth - workDaysCount;
            const monthlySalary = employee.monthlySalary - (employee.monthlySalary / daysInMonth * missingDays);
            total += monthlySalary;
        }
        
        if (employee.dailySalary > 0) {
            // Daily salary - multiply by work days
            const dailySalary = employee.dailySalary * workDaysCount;
            total += dailySalary;
        }
    });
    
    return total;
}

function calculateTotalPayments() {
    return salaryPayments
        .filter(payment => 
            new Date(payment.date).getMonth() === currentMonth &&
            new Date(payment.date).getFullYear() === currentYear
        )
        .reduce((sum, p) => sum + p.amount, 0);
}

function initPersonalManagementEvents() {
    // Employee modal handlers
    document.getElementById('addEmployeeBtn').addEventListener('click', () => {
        document.getElementById('employeeModal').style.display = 'flex';
        document.getElementById('employeeForm').reset();
        document.getElementById('monthlySalaryCheck').checked = true;
        document.getElementById('dailySalaryCheck').checked = false;
        document.getElementById('monthlySalaryGroup').style.display = 'flex';
        document.getElementById('dailySalaryGroup').style.display = 'none';
    });
    
    document.getElementById('closeEmployeeModal').addEventListener('click', () => {
        document.getElementById('employeeModal').style.display = 'none';
    });
    
    document.getElementById('cancelEmployeeBtn').addEventListener('click', () => {
        document.getElementById('employeeModal').style.display = 'none';
    });
    
    // Salary modal handlers
    document.getElementById('addSalaryBtn').addEventListener('click', () => {
        document.getElementById('salaryModal').style.display = 'flex';
        document.getElementById('salaryForm').reset();
        document.getElementById('salaryPaymentDate').valueAsDate = new Date();
    });
    
    document.getElementById('closeSalaryModal').addEventListener('click', () => {
        document.getElementById('salaryModal').style.display = 'none';
    });
    
    document.getElementById('cancelSalaryBtn').addEventListener('click', () => {
        document.getElementById('salaryModal').style.display = 'none';
    });
    
    // Edit Salary modal handlers
    document.getElementById('closeEditSalaryModal').addEventListener('click', () => {
        document.getElementById('editSalaryModal').style.display = 'none';
    });
    
    document.getElementById('cancelEditSalaryBtn').addEventListener('click', () => {
        document.getElementById('editSalaryModal').style.display = 'none';
    });
    
    document.getElementById('deleteSalaryBtn').addEventListener('click', () => {
        if (confirm('Bu ödənişi silmək istədiyinizə əminsiniz?')) {
            const paymentId = document.getElementById('editPaymentId').value;
            salaryPayments = salaryPayments.filter(p => p.id !== paymentId);
            saveSalaryPayments();
            renderSalaryTable();
            document.getElementById('editSalaryModal').style.display = 'none';
            showAlert('success', 'Ödəniş uğurla silindi');
        }
    });
    
    // Month navigation handlers
    document.getElementById('prev-week-personal').addEventListener('click', () => {
        currentWeekStart.setDate(currentWeekStart.getDate() - 7);
        renderPersonalTimeline();
    });
    
    document.getElementById('next-week-personal').addEventListener('click', () => {
        currentWeekStart.setDate(currentWeekStart.getDate() + 7);
        renderPersonalTimeline();
    });
    
    document.getElementById('today-btn-personal').addEventListener('click', () => {
        currentDate = new Date();
        currentWeekStart = new Date(currentDate);
        currentWeekStart.setDate(currentDate.getDate() - currentDate.getDay());
        renderPersonalTimeline();
    });
    
    // Form submissions
    document.getElementById('employeeForm').addEventListener('submit', function(e) {
        e.preventDefault();
        addEmployee();
    });
    
    document.getElementById('salaryForm').addEventListener('submit', function(e) {
        e.preventDefault();
        addSalaryPayment();
    });
    
    document.getElementById('editSalaryForm').addEventListener('submit', function(e) {
        e.preventDefault();
        updateSalaryPayment();
    });
    
    // Export to Excel
    document.getElementById('exportExcelBtn').addEventListener('click', exportPersonalToExcel);
    
    // Salary type checkboxes
    document.getElementById('monthlySalaryCheck').addEventListener('change', function() {
        if (!this.checked && !document.getElementById('dailySalaryCheck').checked) {
            this.checked = true;
            return;
        }
        document.getElementById('monthlySalaryGroup').style.display = this.checked ? 'flex' : 'none';
    });
    
    document.getElementById('dailySalaryCheck').addEventListener('change', function() {
        if (!this.checked && !document.getElementById('monthlySalaryCheck').checked) {
            this.checked = true;
            return;
        }
        document.getElementById('dailySalaryGroup').style.display = this.checked ? 'flex' : 'none';
    });
}

// User roles and permissions
const userRoles = {
   
    manager: { password: 'v1611', tabs: ['dashboard', 'transactions', 'categories', 'reservations', 'personal'] },
    reception: { password: null, tabs: ['reservations'] }
};

let currentUser = null;

// Initialize login system
function initLoginSystem() {
    const loginModal = document.getElementById('loginModal');
    const loginForm = document.getElementById('login-form');
    const roleSelect = document.getElementById('login-role');
    const passwordGroup = document.getElementById('password-group');
    
    // Show/hide password field based on role
    roleSelect.addEventListener('change', function() {
        const role = this.value;
        passwordGroup.style.display = userRoles[role]?.password ? 'block' : 'none';
    });
    
    // Handle login
    loginForm.addEventListener('submit', function(e) {
        e.preventDefault();
        
        const role = roleSelect.value;
        const password = document.getElementById('login-password').value;
        
        if (!role) {
            showAlert('danger', 'Zəhmət olmasa rol seçin');
            return;
        }
        
        if (userRoles[role].password && userRoles[role].password !== password) {
            showAlert('danger', 'Yanlış parol');
            return;
        }
        
        currentUser = role;
        loginModal.style.display = 'none';
        
        // Set up UI based on role
        setupUIForUser(role);
        showAlert('success', `Xoş gəlmisiniz, ${role}`);
    });
}

// Set up UI based on user role
function setupUIForUser(role) {
    const allowedTabs = userRoles[role].tabs;
    
    // Hide all tabs first
    document.querySelectorAll('.tab').forEach(tab => {
        tab.style.display = 'none';
    });
    
    // Show only allowed tabs
    allowedTabs.forEach(tabId => {
        const tab = document.querySelector(`.tab[data-tab="${tabId}"]`);
        if (tab) tab.style.display = 'block';
    });
    
    // Activate first allowed tab
    if (allowedTabs.length > 0) {
        document.querySelector(`.tab[data-tab="${allowedTabs[0]}"]`).click();
    }
    
    // Hide financial export button for reception
    if (role === 'reception') {
        document.getElementById('export-excel-btn').style.display = 'none';
    } else {
        document.getElementById('export-excel-btn').style.display = 'block';
    }
}

// Update DOMContentLoaded event listener
document.addEventListener('DOMContentLoaded', function() {
    initLoginSystem(); // Initialize login system first
    
    // Rest of your existing initialization code...
    const now = new Date();
    document.getElementById('transaction-date').value = now.toISOString().slice(0, 16);
    
    const firstDay = new Date(now.getFullYear(), now.getMonth(), 1).toISOString().split('T')[0];
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('export-start-date').value = firstDay;
    document.getElementById('export-end-date').value = today;
    
    // Don't initialize other parts until login
});
// Make function available globally for inline event handlers
window.editPayment = editPayment;
</script>
</body>
</html>
